"use strict";angular.module("app",["ngRoute"]).config(["$routeProvider","$locationProvider",function(a,b){b.html5Mode(!1).hashPrefix("!"),a.when("/",{templateUrl:"views/main.html",controller:"Reader_controller"}).when("/:isbn",{templateUrl:"views/main.html",controller:"Reader_controller"}).otherwise({redirectTo:"/"})}]).run(["$document","$rootScope",function(a,b){a.bind("keydown",function(a){b.$broadcast("keydown",a),b.$broadcast("keydown:"+a.which,a)})}]).controller("Reader_controller",["$scope","$timeout","$routeParams","$exceptionHandler","Book",function(a,b,c,d,e){function f(b){var c=$("<p>"+JSON.stringify(b)+"</p>");switch(b.code){case 0:a.book.hasNext=!1;break;case 4:a.book.hasPrevious=!1;break;case 7:$('[data-test="status"]').removeAttr("data-test"),c.attr("data-test","status"),g=b;break;case 9:case 10:case 11:case 12:case 13:case 14:case 15:case 16:c.attr("data-test","error")}$("#log .panel-body").prepend(c)}a.book={isbn:c.isbn||"",url:"",hasNext:!0,hasPrevious:!0};var g=null;if(a.environment={options:[{label:"QA",url:"https://qa.mobcastdev.com/api/service/catalogue/books/"},{label:"Prod",url:"https://api.blinkboxbooks.com/service/catalogue/books/"},{label:"Local",url:"/books/"}],current:null},a.environment.current=isNaN(c.env)?a.environment.options[0]:a.environment.options[c.env],a.layout={width:isNaN(parseInt(c.width))?400:parseInt(c.width),height:isNaN(parseInt(c.height))?600:parseInt(c.height),columns:isNaN(parseInt(c.columns))?1:parseInt(c.columns),padding:isNaN(parseInt(c.padding))?0:parseInt(c.padding)},a.preferences={margin:c.margin||"medium",textAlign:c.textAlign||"left",fontFamily:c.fontFamily||"Helvetica",theme:c.theme||"light",lineHeight:isNaN(parseFloat(c.width))?1.2:parseFloat(c.lineHeight),fontSize:c.fontSize||1},c.publisherStyles)try{a.preferences.publisherStyles=$.parseJSON(c.publisherStyles)}catch(h){}c.maxChapterElements&&(a.preferences.maxChapterElements=Number(c.maxChapterElements)),c.preloadRange&&(a.preferences.preloadRange=Number(c.preloadRange)),c.transitionDuration&&(a.preferences.transitionDuration=Number(c.transitionDuration)),c.transitionTimingFunction&&(a.preferences.transitionTimingFunction=c.transitionTimingFunction),a.formSettings={lineHeight:{min:1.1,max:20,step:.01},fontSize:{min:.5,max:15,step:.1},fonts:["Helvetica","Times new Roman","Courier New","Arial"],alignment:["left","justify"],margins:["min","medium","max"],themes:["light","transparent","dark","sepia"]},a.handlers={prev:function(){$('[data-test="status"]').removeAttr("data-test"),READER.prev(),a.book.hasNext=!0},next:function(){$('[data-test="status"]').removeAttr("data-test"),READER.next(),a.book.hasPrevious=!0},cfi:function(){try{f(decodeURIComponent(READER.getCFI()))}catch(a){f(a)}},bookmark:function(){$('[data-test="status"]').removeAttr("data-test"),g.bookmarksInPage.length?g.bookmarksInPage.forEach(READER.removeBookmark):READER.setBookmark()}},a.$watch("environment.current.url + book.isbn",function(b){a.book.isbn&&e.get(b).then(function(b){a.book.url=b},function(a){d({message:a.status,stack:a.config},a)})});var i=!1;a.$watch("book.url",function(c){if(c){READER.enableDebug();var d=READER.init({container:"#reader_container",width:a.layout.width,height:a.layout.height,padding:a.layout.padding,columns:a.layout.columns,url:c,bookmarks:[],listener:function(a){b(function(){f(a)})},preferences:a.preferences});i||(d.then(function(){a.$watch("preferences",READER.setPreferences,!0),a.$watch("layout",READER.resizeContainer,!0)}),i=!0)}}),a.$on("keydown:66",function(){b(a.handlers.bookmark)}),a.$on("keydown:39",function(){b(a.handlers.next)}),a.$on("keydown:37",function(){b(a.handlers.prev)})}]).factory("Book",["$http","$q",function(a,b){return{get:function(c){var d=b.defer();return 0===c.indexOf("/books/")?d.resolve(c):a({url:c,method:"GET"}).then(function(a){if(a.data.links&&a.data.links.length>0){var b,c;for(b=0,c=a.data.links.length;b!==c;b+=1){var e=a.data.links[b];if("Sample"===e.title&&""!==e.href){var f=document.createElement("a");f.href=e.href;var g=0===f.pathname.indexOf("/")?f.pathname:"/"+f.pathname;d.resolve("//"+f.hostname+"/params;v=0"+g)}}}else d.reject(a)},d.reject),d.promise}}}]);