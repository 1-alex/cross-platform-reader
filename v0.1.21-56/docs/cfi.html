<!DOCTYPE html>

<html>
<head>
  <title>cfi.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="bookdata.html">
                bookdata.js
              </a>
            
              
              <a class="source" href="cfi.html">
                cfi.js
              </a>
            
              
              <a class="source" href="config.html">
                config.js
              </a>
            
              
              <a class="source" href="display.html">
                display.js
              </a>
            
              
              <a class="source" href="events.html">
                events.js
              </a>
            
              
              <a class="source" href="formatting.html">
                formatting.js
              </a>
            
              
              <a class="source" href="navigation.html">
                navigation.js
              </a>
            
              
              <a class="source" href="parse.html">
                parse.js
              </a>
            
              
              <a class="source" href="styles.html">
                styles.js
              </a>
            
              
              <a class="source" href="wrapper.html">
                wrapper.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>cfi.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-pi">'use strict'</span>;

<span class="hljs-comment">/* jshint unused: true */</span>
<span class="hljs-comment">/* exported Reader */</span>
<span class="hljs-comment">/* globals $, EPUBcfi */</span>

<span class="hljs-keyword">var</span> Reader = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(r)</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Private array for blacklisted classes. The CFI library will ignore any DOM elements that have these classes.
<a href="https://github.com/readium/EPUBCFI/blob/864527fbb2dd1aaafa034278393d44bba27230df/spec/javascripts/cfi_instruction_spec.js#L137">Read more</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> _classBlacklist = [<span class="hljs-string">'bookmark'</span>, <span class="hljs-string">'cpr-marker'</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>The <strong>CFI</strong> object exposes methods to handle CFIs. it is <strong>not</strong> intended to be exposed to the client directly.</p>
<ul>
<li><a href="#setUp"><code>setUp</code></a></li>
<li><a href="#getCFIObject"><code>getCFIObject</code></a></li>
<li><a href="#setCFI"><code>setCFI</code></a></li>
<li><a href="#addOneNodeToCFI"><code>addOneNodeToCFI</code></a></li>
<li><a href="#addOneWordToCFI"><code>addOneWordToCFI</code></a></li>
<li><a href="#goToCFI"><code>goToCFI</code></a></li>
<li>reset</li>
</ul>

            </div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Helper methods:</p>
<ul>
<li><a href="#updateContext"><code>updateContext</code></a></li>
<li><a href="#addContext"><code>addContext</code></a></li>
<li><a href="#removeContext"><code>removeContext</code></a></li>
<li><a href="#addOneNodeToCFI"><code>addOneNodeToCFI</code></a></li>
<li><a href="#getChapterFromCFI"><code>getChapterFromCFI</code></a></li>
</ul>
<p>Other private methods</p>
<ul>
<li><a href="#getFirstNode"><code>getFirstNode</code></a></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>	r.CFI = {</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>The <code>opfCFI</code> is used to generate the first part of any valid CFI. This part points to the <strong>file</strong> containing the chapter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		opfCFI: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Variable that contains a partial CFI representing the DOM tree between the reader container and the body. It is different between clients and has to be constructed dynamically.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		context: <span class="hljs-literal">null</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p><a name="setUp"></a>  Initialises the CFI variables, should be called whenever we load a new chapter
<code>chapter</code> the current chapter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		setUp: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(chapter)</span> {</span>
			<span class="hljs-keyword">if</span> (r.opf === <span class="hljs-literal">null</span>) {
				<span class="hljs-keyword">return</span>;
			}
			<span class="hljs-keyword">try</span> {
				<span class="hljs-keyword">var</span> chapterId = $(r.opf).find(<span class="hljs-string">'spine'</span>).children()[chapter].getAttribute(<span class="hljs-string">'idref'</span>);
				r.CFI.opfCFI = EPUBcfi.Generator.generatePackageDocumentCFIComponent(chapterId, r.opf);
			} <span class="hljs-keyword">catch</span> (err) {</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>cannot generate CFI</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				r.Notify.error($.extend({}, r.Event.ERR_CFI_GENERATION, {details: err, call: <span class="hljs-string">'CFI.setUp'</span>}));
			}
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p><a name="updateContext"></a> This function will generate the CFI path between the body and the reader, specific to every client.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		updateContext: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
			<span class="hljs-keyword">if</span>(!r.$reader || !r.CFI.opfCFI){
				<span class="hljs-keyword">return</span>;
			}

			<span class="hljs-keyword">var</span> elCFI = EPUBcfi.Generator.generateElementCFIComponent(r.$reader[<span class="hljs-number">0</span>]);
			<span class="hljs-keyword">var</span> completeCFI = EPUBcfi.Generator.generateCompleteCFI(r.CFI.opfCFI, elCFI);
			<span class="hljs-keyword">var</span> part_1 = completeCFI.split(<span class="hljs-string">'!/4'</span>)[<span class="hljs-number">1</span>];
			r.CFI.context = part_1.split(<span class="hljs-string">'['</span> + (r.$reader[<span class="hljs-number">0</span>].id) + <span class="hljs-string">']'</span>)[<span class="hljs-number">0</span>] + <span class="hljs-string">'['</span> + (r.$reader[<span class="hljs-number">0</span>].id) + <span class="hljs-string">']'</span>;
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p><a name="addContext"></a> This function will add the context into a CFI to generate a complete and valid CFI to be used with the current chapter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		addContext: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(completeCFI)</span>{</span>
			<span class="hljs-keyword">if</span>($.type(completeCFI) !== <span class="hljs-string">'string'</span>){
				<span class="hljs-keyword">return</span>;
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>The reader context would not normally be updated anymore, but this is a workaround to the web-app, when they move the reader in the DOM and the context changes. Until that is fixed, we must update the context all the time.
if(r.CFI.context === null){</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			r.CFI.updateContext();</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
			<span class="hljs-keyword">if</span>(completeCFI.indexOf(<span class="hljs-string">'!/4'</span>) !== -<span class="hljs-number">1</span>){</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Remove any IDs that contain “.”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				completeCFI = completeCFI.replace(<span class="hljs-regexp">/\[([\w-_])*\.([\w-_])*\]/gi</span>, <span class="hljs-string">''</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Take into account the style tags and Google font tag (current node -= 2/3)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">var</span> contextSplit = completeCFI.split(<span class="hljs-string">'!/4'</span>);
				completeCFI = contextSplit[<span class="hljs-number">0</span>] + <span class="hljs-string">'!/4'</span> + r.CFI.context + contextSplit[<span class="hljs-number">1</span>];
			}

			<span class="hljs-keyword">return</span> completeCFI;
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p><a name="removeContext"></a> This function will remove the context from a CFI to generate a re-usable, generic, CFI.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		removeContext: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(completeCFI)</span>{</span>
			<span class="hljs-keyword">if</span>($.type(completeCFI) !== <span class="hljs-string">'string'</span>){
				<span class="hljs-keyword">return</span>;
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>The reader context would not normally be updated anymore, but this is a workaround to the web-app, when they move the reader in the DOM and the context changes. Until that is fixed, we must update the context all the time.
if(r.CFI.context === null){</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			r.CFI.updateContext();</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
			<span class="hljs-keyword">if</span>(completeCFI.indexOf(r.CFI.context) !== -<span class="hljs-number">1</span>){
				completeCFI = completeCFI.replace(r.CFI.context, <span class="hljs-string">''</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Remove any IDs that contain “.”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				completeCFI = completeCFI.replace(<span class="hljs-regexp">/\[([\w-_])*\.([\w-_])*\]/gi</span>, <span class="hljs-string">''</span>);
			}

			<span class="hljs-keyword">return</span> completeCFI;
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p><a name="getCFIObject"></a> Return the current position’s CFI and a preview of the current text.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		getCFIObject: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span></pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>The reader context would not normally be updated anymore, but this is a workaround to the web-app, when they move the reader in the DOM and the context changes. Until that is fixed, we must update the context all the time.
if(r.CFI.context === null){</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			r.CFI.updateContext();</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>}</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
			<span class="hljs-keyword">try</span> {
				<span class="hljs-keyword">var</span> startTextNode = getFirstNode();
				<span class="hljs-keyword">var</span> elCFI = <span class="hljs-literal">null</span>;
				<span class="hljs-keyword">if</span> (startTextNode.textNode.nodeType === <span class="hljs-number">3</span>) {
					elCFI = EPUBcfi.Generator.generateCharacterOffsetCFIComponent(startTextNode.textNode, startTextNode.offset, _classBlacklist);
				} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (startTextNode.textNode.nodeType === <span class="hljs-number">1</span>) {
					elCFI = EPUBcfi.Generator.generateElementCFIComponent(startTextNode.textNode, _classBlacklist);
				}
				<span class="hljs-keyword">if</span> (elCFI !== <span class="hljs-literal">null</span>) {

					<span class="hljs-keyword">var</span> completeCFI = EPUBcfi.Generator.generateCompleteCFI(r.CFI.opfCFI, elCFI);
					<span class="hljs-keyword">var</span> i;</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>getFirstNode does not have a blacklist and the injected markers break the CFI generation.
To ensure the correct CFI is generated, we must test it first. If the EPUBcfi library returns more than one text nodes, we must update the offset to include the previous text nodes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">var</span> $node = $(EPUBcfi.Interpreter.getTargetElement(completeCFI, document, _classBlacklist));
					<span class="hljs-keyword">if</span>($node.length &gt; <span class="hljs-number">1</span> &amp;&amp; $node[<span class="hljs-number">0</span>].nodeType === <span class="hljs-number">3</span>) {
						<span class="hljs-keyword">var</span> offset = startTextNode.offset;
						<span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; $node.length - <span class="hljs-number">1</span>; i++){
							offset += $node[i].length;
						}
						completeCFI = completeCFI.replace(<span class="hljs-regexp">/:\d+/</span>, <span class="hljs-string">':'</span> + offset);
					}

					<span class="hljs-keyword">var</span> result = {
						CFI: r.CFI.removeContext(completeCFI),
						preview: startTextNode.preview
					};

					<span class="hljs-keyword">var</span> chapter =  r.CFI.getChapterFromCFI(result.CFI);
					<span class="hljs-keyword">var</span> sections = [];

					<span class="hljs-keyword">var</span> _parseItem = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(item)</span>{</span>
						<span class="hljs-keyword">if</span>(item.href.indexOf(href) !== -<span class="hljs-number">1</span>){
							sections.push(item);
						}
						<span class="hljs-keyword">if</span>(item.children){
							<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = item.children.length; i &lt; l; i++){
								_parseItem(item.children[i]);
							}
						}
					};

					<span class="hljs-keyword">if</span>(chapter !== -<span class="hljs-number">1</span>){
						<span class="hljs-keyword">var</span> href = r.SPINE[chapter].href;
						<span class="hljs-keyword">for</span>(i = <span class="hljs-number">0</span>; i &lt; r.TOC.length; i++){
							_parseItem(r.TOC[i]);
						}
					}
					<span class="hljs-keyword">if</span>(sections.length){
						<span class="hljs-keyword">if</span>(sections.length &gt; <span class="hljs-number">1</span>){
							<span class="hljs-keyword">var</span> currentPage =  r.Navigation.getPage();</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>if more than one match, compare page numbers of different elements and identify where the current page is</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>							<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>, l = sections.length; j &lt; l; j++){</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>get the anchor the url is pointing at</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>								<span class="hljs-keyword">var</span> anchor = sections[j].href.split(<span class="hljs-string">'#'</span>);
								anchor = anchor.length &gt; <span class="hljs-number">1</span> ? <span class="hljs-string">'#'</span>+anchor[<span class="hljs-number">1</span>] : <span class="hljs-literal">null</span>;
								<span class="hljs-keyword">if</span>(!anchor){
									<span class="hljs-keyword">continue</span>;
								} <span class="hljs-keyword">else</span> {
									<span class="hljs-keyword">var</span> $anchor = $(anchor);</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>we have to check if the element exists in the current chapter. Samples sometimes cut portions of the document, resulting in missing links</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>									<span class="hljs-keyword">if</span>($anchor.length){
										<span class="hljs-keyword">var</span> anchorPage = r.returnPageElement($anchor);
										<span class="hljs-keyword">if</span>(anchorPage &gt; currentPage){
											<span class="hljs-keyword">break</span>;
										}
										result.chapter = sections[j].label;
									}
								}
							}
						} <span class="hljs-keyword">else</span> {
							result.chapter = sections[<span class="hljs-number">0</span>].label;
						}
					}
					<span class="hljs-keyword">return</span> result;
				}
				<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
			}
			<span class="hljs-keyword">catch</span> (err) {</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>cannot generate CFI</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				r.Notify.error($.extend({}, r.Event.ERR_CFI_GENERATION, {details: err, call: <span class="hljs-string">'getCFIObject'</span>}));
			}
		},
		getCFI: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
			<span class="hljs-keyword">return</span> <span class="hljs-built_in">encodeURIComponent</span>(<span class="hljs-built_in">JSON</span>.stringify(r.CFI.getCFIObject()));
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p><a name="setCFI"></a> This function will inject a blacklisted market into the DOM to allow the user to identify where a CFI points to.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		setCFI: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cfi, markerClass)</span> {</span> <span class="hljs-comment">// Add an element to a CFI point</span>
			<span class="hljs-keyword">if</span>($(<span class="hljs-string">'.'</span>+(markerClass ? markerClass : <span class="hljs-string">'bookmark'</span>)+<span class="hljs-string">'[data-cfi="'</span> + cfi + <span class="hljs-string">'"]'</span>).length === <span class="hljs-number">0</span>){
				<span class="hljs-keyword">try</span> {
					<span class="hljs-comment">/* TODO: *** REFACTORING CANDIDATE ***
					 ideally, we should not end up with bookmark markers in a span element within an image element
					 the mainl problem is that it's not possible locate the offset of this span
					 instead, we should be adding the marker to the img attributes
					 also, it would be better to gert the markerClass to be passed in in all circumstances
					 */</span>
					<span class="hljs-keyword">var</span> marker = <span class="hljs-string">'&lt;span class="'</span>+ (markerClass ? markerClass : <span class="hljs-string">'bookmark'</span>) +<span class="hljs-string">'" data-cfi="'</span> + cfi + <span class="hljs-string">'"&gt;&lt;/span&gt;'</span>;
					cfi = r.CFI.addContext(cfi);
					<span class="hljs-keyword">var</span> $node = $(EPUBcfi.Interpreter.getTargetElement(cfi, document, _classBlacklist)),
						$nodeClone = $node.clone();
					<span class="hljs-keyword">if</span> ($node.length) {
						<span class="hljs-keyword">if</span> ($node[<span class="hljs-number">0</span>].nodeType === <span class="hljs-number">1</span>) { <span class="hljs-comment">// append to element</span>
							$node.before($(marker));
						}
						<span class="hljs-keyword">if</span> ($node[<span class="hljs-number">0</span>].nodeType === <span class="hljs-number">3</span>) { <span class="hljs-comment">// inject into the text node</span>
							$nodeClone = $node.parent().clone();
							r.CFI.addOneWordToCFI(cfi, $node, marker);
						}
					}
					<span class="hljs-keyword">return</span> $nodeClone;
				}
				<span class="hljs-keyword">catch</span> (err) {</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>cannot insert CFI</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					r.Notify.error($.extend({}, r.Event.ERR_CFI_INSERTION, {details: err, call: <span class="hljs-string">'setCFI'</span>}));
				}
			}
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p><a name="addOneNodeToCFI"></a> Helper function that moves the CFI to the next node. This is required to avoid a bug in some browsers that displays the current CFI on the previous page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		addOneNodeToCFI : <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(c, el, marker)</span> {</span>
			<span class="hljs-keyword">var</span> $nextNode = getNextNode(el);
			<span class="hljs-keyword">var</span> cfi = c;
			<span class="hljs-keyword">if</span> ($nextNode) {
				<span class="hljs-keyword">if</span> ($nextNode[<span class="hljs-number">0</span>].nodeType === <span class="hljs-number">3</span> &amp;&amp; $nextNode[<span class="hljs-number">0</span>].length &gt; <span class="hljs-number">1</span>) {
					<span class="hljs-keyword">try</span> {
						cfi = EPUBcfi.Generator.generateCharacterOffsetCFIComponent($nextNode[<span class="hljs-number">0</span>], <span class="hljs-number">2</span>, _classBlacklist);
						cfi = EPUBcfi.Generator.generateCompleteCFI(r.CFI.opfCFI, cfi);
					}
					<span class="hljs-keyword">catch</span> (err) { }
				} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ($nextNode[<span class="hljs-number">0</span>].nodeType === <span class="hljs-number">1</span>) {
					$nextNode.before($(marker));
					<span class="hljs-keyword">return</span>;
				}
				<span class="hljs-keyword">try</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Ignore errors and jump to the next node if something wrong happens when we inject the element into the CFI address</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					EPUBcfi.Interpreter.injectElement(cfi, document, marker, _classBlacklist);
				}
				<span class="hljs-keyword">catch</span> (e) {
					r.CFI.addOneNodeToCFI(cfi, $nextNode, marker);
				}
			}
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p><a name="addOneWordToCFI"></a> Add one position to the cfi if we are in a text node to avoid the CFI to be set in the previous page.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		addOneWordToCFI : <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cfi, el, marker)</span> {</span>
			<span class="hljs-keyword">var</span> pos = <span class="hljs-built_in">parseInt</span>(cfi.split(<span class="hljs-string">':'</span>)[<span class="hljs-number">1</span>].split(<span class="hljs-string">')'</span>)[<span class="hljs-number">0</span>], <span class="hljs-number">10</span>);
			<span class="hljs-keyword">var</span> words = el.text().substring(pos).split(<span class="hljs-regexp">/\s+/</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>find next word position</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (el.text().length &gt; <span class="hljs-number">1</span> &amp;&amp; words.length &amp;&amp; pos + words[<span class="hljs-number">0</span>].length &lt; el.text().length) {
				pos = pos + words[<span class="hljs-number">0</span>].length;
				cfi = cfi.split(<span class="hljs-string">':'</span>)[<span class="hljs-number">0</span>] + <span class="hljs-string">':'</span> + pos + <span class="hljs-string">')'</span>;
				EPUBcfi.Interpreter.injectElement(cfi, document, marker, _classBlacklist);
			} <span class="hljs-keyword">else</span> {
				r.CFI.addOneNodeToCFI(cfi, el, marker);
			}
		},
		findCFIElement : <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(value)</span> {</span>
			<span class="hljs-keyword">var</span> elem = $(<span class="hljs-string">'*[data-cfi="'</span> + value + <span class="hljs-string">'"]'</span>);
			<span class="hljs-keyword">if</span> (elem.length) {
				<span class="hljs-keyword">var</span> tagName = elem[<span class="hljs-number">0</span>].parentElement.tagName;
				<span class="hljs-comment">/* TODO: *** REFACTORING CANDIDATE ***
				 ideally, we should not end up with bookmark markers in a span element within an image element
				 the main problem is that it's not possible locate the offset of this span
				 instead, we should be adding the marker to the img element attributes
				 */</span>
				<span class="hljs-keyword">return</span> tagName === <span class="hljs-string">'IMG'</span> ? r.returnPageElement(elem[<span class="hljs-number">0</span>].parentElement) : r.returnPageElement(elem[<span class="hljs-number">0</span>]);
			}
			<span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p><a name="goToCFI"></a>Find and load the page that contains the CFI’s marker. If the marker does not exist, it will be injected in the chapter. If the CFI points to another chapter it will load that chapter first.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		goToCFI : <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cfi, fixed)</span> {</span>
			<span class="hljs-keyword">var</span> _fixed = !!fixed;

			<span class="hljs-keyword">var</span> _go = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
				<span class="hljs-keyword">if</span> (r.CFI.findCFIElement(cfi) !== -<span class="hljs-number">1</span>) {
					r.Navigation.loadPage(r.CFI.findCFIElement(cfi));
				} <span class="hljs-keyword">else</span> {
					r.CFI.setCFI(cfi, <span class="hljs-string">'cpr-marker'</span>);
					<span class="hljs-keyword">var</span> p = r.CFI.findCFIElement(cfi);
					<span class="hljs-keyword">if</span> (p !== -<span class="hljs-number">1</span>) {
						r.Navigation.loadPage(p);
					} <span class="hljs-keyword">else</span> {
						r.Navigation.loadPage(<span class="hljs-number">0</span>);
					}
				}</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Update reader position</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        <span class="hljs-keyword">if</span>(!_fixed){
          r.Navigation.update();
        }
			};

			<span class="hljs-keyword">var</span> chapter = r.CFI.getChapterFromCFI(cfi);
			<span class="hljs-keyword">if</span>(chapter !== -<span class="hljs-number">1</span>){
				<span class="hljs-keyword">if</span>(r.Navigation.getChapter() === chapter){
					_go();
					<span class="hljs-keyword">var</span> defer = $.Deferred();
					defer.resolve();
					<span class="hljs-keyword">return</span> defer.promise();
				} <span class="hljs-keyword">else</span> {
					<span class="hljs-keyword">return</span> r.loadChapter(chapter).then(_go);
				}
			} <span class="hljs-keyword">else</span> {
				r.Notify.error($.extend({}, r.Event.ERR_INVALID_ARGUMENT, {details: <span class="hljs-string">'Invalid CFI'</span>, value: cfi, call: <span class="hljs-string">'goToCFI'</span>}));
			}
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p><a name="getChapterFromCFI"></a> This function will calculate what chapter the CFI is pointing at and return the its index (or -1 on failure).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		getChapterFromCFI: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cfi)</span>{</span>
			<span class="hljs-keyword">if</span>($.type(cfi) === <span class="hljs-string">'string'</span>){
				<span class="hljs-keyword">var</span> chapter = cfi.split(<span class="hljs-string">'/'</span>);
				<span class="hljs-keyword">if</span>(chapter.length &gt;= <span class="hljs-number">3</span> &amp;&amp; $.isNumeric(chapter[<span class="hljs-number">2</span>].slice(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>))){
					<span class="hljs-keyword">return</span> <span class="hljs-built_in">parseInt</span>(<span class="hljs-built_in">parseInt</span>(chapter[<span class="hljs-number">2</span>].slice(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>), <span class="hljs-number">10</span>) / <span class="hljs-number">2</span> - <span class="hljs-number">1</span>, <span class="hljs-number">10</span>);
				}
			}
			<span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
		},
		reset : <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
			r.CFI.opfCFI = <span class="hljs-literal">null</span>;
			r.CFI.context = <span class="hljs-literal">null</span>;
		}
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p><a name="getFirstNode"></a> Helper function that returns the first node in the current page displayed by the reader.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> getFirstNode = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>

		<span class="hljs-keyword">var</span> range;
		<span class="hljs-keyword">var</span> textNode;
		<span class="hljs-keyword">var</span> offset;
		<span class="hljs-keyword">var</span> container = r.$reader[<span class="hljs-number">0</span>];
		<span class="hljs-keyword">var</span> rect = container.getBoundingClientRect();

		<span class="hljs-comment">/* standard */</span>
		<span class="hljs-keyword">if</span> (document.caretPositionFromPoint) {
			range = document.caretPositionFromPoint(rect.left - <span class="hljs-built_in">parseInt</span>(r.$reader.css(<span class="hljs-string">'left'</span>), <span class="hljs-number">10</span>), rect.top);
			textNode = range.offsetNode;
			offset = range.offset;
			<span class="hljs-comment">/* WebKit */</span>
		} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (document.caretRangeFromPoint) {
			range = document.caretRangeFromPoint(rect.left - <span class="hljs-built_in">parseInt</span>(r.$reader.css(<span class="hljs-string">'left'</span>), <span class="hljs-number">10</span>), rect.top);
			textNode = range.startContainer;
			offset = range.startOffset;
		}

		<span class="hljs-comment">/* Make sure textNode is part of the reader... */</span>
		<span class="hljs-keyword">if</span> (!r.$reader.has(textNode).length) {
			<span class="hljs-comment">/* Reset offset since textNode changed. */</span>
			offset = <span class="hljs-number">0</span>;
			<span class="hljs-comment">/* TextNode is the first node that contains text, otherwise get the first child node. */</span>
			textNode = container.childNodes.length &gt; <span class="hljs-number">0</span> &amp;&amp; $(container.childNodes[<span class="hljs-number">0</span>]).text().trim().length ? container.childNodes[<span class="hljs-number">0</span>] : r.$reader.children().first()[<span class="hljs-number">0</span>];
		}

		<span class="hljs-keyword">var</span> findLeafNode = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(el)</span> {</span>
			<span class="hljs-keyword">var</span> $el = $(el);
			<span class="hljs-comment">/* Return a non-empty textNode or null */</span>
			<span class="hljs-keyword">if</span> (el === <span class="hljs-literal">null</span> || !el.childNodes || el.childNodes.length === <span class="hljs-number">0</span>) {
				<span class="hljs-keyword">return</span> el;
			}
			<span class="hljs-comment">/* Return the element if it only has one child and it is in the blacklist */</span>
			<span class="hljs-keyword">if</span> (el.childNodes.length === <span class="hljs-number">1</span> &amp;&amp; _hasClass($el.contents(), _classBlacklist)) { <span class="hljs-comment">// TODO: Explore more options</span>
				<span class="hljs-keyword">return</span> el;
			}
			<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = $el.contents().length; i &lt; l; i++){
				<span class="hljs-keyword">var</span> $child = $($el.contents()[i]);
				<span class="hljs-keyword">if</span>(!_hasClass($child, _classBlacklist)){
					<span class="hljs-comment">/* reset offset since textNode changed */</span>
					offset = <span class="hljs-number">0</span>;
					<span class="hljs-keyword">return</span> findLeafNode($child[<span class="hljs-number">0</span>]);
				}
			}
			<span class="hljs-keyword">return</span> el;
		};

		<span class="hljs-comment">/* generate a preview from the current position */</span>
		<span class="hljs-keyword">var</span> preview = <span class="hljs-string">''</span>,
			words = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Calculates the length of a string and returns true if the length has the minimum number of words.
Returns true if text is a string and its length is &gt; than the desired number of words, false otherwise.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> hasDesiredLength = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(text)</span> {</span>
			<span class="hljs-keyword">if</span> ($.type(text) !== <span class="hljs-string">'string'</span>) {
				<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Check number of words so far.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">var</span> whitespaces = text.match(<span class="hljs-regexp">/\S+/g</span>);
			words = whitespaces ? text.match(<span class="hljs-regexp">/\S+/g</span>).length : <span class="hljs-number">0</span>;
			<span class="hljs-keyword">return</span> words &gt; <span class="hljs-number">100</span>;
		};

		<span class="hljs-keyword">var</span> _hasClass = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(el, classNames)</span> {</span>
			<span class="hljs-keyword">var</span> classes = <span class="hljs-string">'.'</span> + classNames.join(<span class="hljs-string">', .'</span>);
			<span class="hljs-keyword">return</span> el.filter(classes).length &gt; <span class="hljs-number">0</span>;
		};</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Loops through all adjacent nodes to generate the preview, starting with the first text node.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> generatePreview = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
			<span class="hljs-keyword">var</span> $currentNode = $(textNode);
			<span class="hljs-keyword">var</span> text = offset ? <span class="hljs-string">'&amp;#8230;'</span> + $currentNode.text().substr(offset) : $currentNode.text();  <span class="hljs-comment">// prepend ellipses to previews which don't begin at the start of a sentence</span>

			generatePreview :
			<span class="hljs-keyword">while</span> (!hasDesiredLength(text)) {
				<span class="hljs-keyword">var</span> $next = getNextNode($currentNode);

				<span class="hljs-keyword">if</span> ($next &amp;&amp; $next.length) {
					$currentNode = $next;
					text += $currentNode.text().length &amp;&amp; $currentNode[<span class="hljs-number">0</span>].tagName !== <span class="hljs-string">'SCRIPT'</span> ? $currentNode.text().trim() + <span class="hljs-string">' '</span> : <span class="hljs-string">''</span>;
				} <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>No more content go get text from, break operation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">break</span> generatePreview;
				}
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Trim preview to 100 words.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">var</span> trimmed = text.trim().match(<span class="hljs-regexp">/((\S+\s+){100})/</span>);
			<span class="hljs-keyword">return</span> trimmed &amp;&amp; trimmed.length ? trimmed[<span class="hljs-number">0</span>] : text;
		};</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Get the top element that is the child of the reader container.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> $currentNode = $(textNode);
		<span class="hljs-keyword">while</span> ($currentNode.parent().length &amp;&amp; !$currentNode.parent().is(r.$reader)) {
			$currentNode = $currentNode.parent();
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Check that the first tag has text, if not, add any image/table we can find.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (!$currentNode.text().trim().length) {
			<span class="hljs-keyword">var</span> $img = $currentNode.find(<span class="hljs-string">'img'</span>);
			<span class="hljs-keyword">var</span> $table = $currentNode.find(<span class="hljs-string">'table'</span>);
			<span class="hljs-keyword">var</span> $svg = $currentNode.find(<span class="hljs-string">'svg'</span>);

			<span class="hljs-keyword">if</span> ($img.length) {
				preview = <span class="hljs-string">'Image: '</span> + ($img.attr(<span class="hljs-string">'alt'</span>) ? $img.attr(<span class="hljs-string">'alt'</span>) : <span class="hljs-string">'No description'</span>);
			} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ($table.length) {
				preview = <span class="hljs-string">'Table'</span>;
			} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> ($svg.length) {
				preview = <span class="hljs-string">'Image: No description'</span>;
			}
		} <span class="hljs-keyword">else</span> {
			preview = generatePreview();
		}

		<span class="hljs-keyword">return</span> {
			textNode: findLeafNode(textNode),
			offset: offset,
			preview: preview
		};
	};

	<span class="hljs-keyword">var</span> getNextNode = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">($el)</span> {</span>
		<span class="hljs-keyword">if</span> ($el.length) {
			$el = $el.last();
			<span class="hljs-keyword">var</span> nodes = $el.parent().contents().filter(<span class="hljs-string">':not(.'</span>+_classBlacklist.join(<span class="hljs-string">',.'</span>)+<span class="hljs-string">')'</span>);
			<span class="hljs-keyword">var</span> index = $.inArray($el[<span class="hljs-number">0</span>], nodes);
			<span class="hljs-keyword">if</span> (nodes[index + <span class="hljs-number">1</span>]) {
				<span class="hljs-keyword">var</span> $next = $(nodes[index + <span class="hljs-number">1</span>]);</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>ignore empty textnodes</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span>($next[<span class="hljs-number">0</span>].nodeType === <span class="hljs-number">3</span> &amp;&amp; !$next.text().trim().length){
					<span class="hljs-keyword">return</span> getNextNode($next);
				}
				<span class="hljs-keyword">return</span> $next;
			} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!$el.parent().is(r.$reader)) {
				<span class="hljs-keyword">return</span> getNextNode($el.parent());
			}
		}
		<span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;
	};

	<span class="hljs-keyword">return</span> r;
}(Reader || {}));</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
