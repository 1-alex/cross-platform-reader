<!DOCTYPE html>

<html>
<head>
  <title>navigation.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="book.html">
                book.js
              </a>
            
              
              <a class="source" href="bookdata.html">
                bookdata.js
              </a>
            
              
              <a class="source" href="cfi.html">
                cfi.js
              </a>
            
              
              <a class="source" href="config.html">
                config.js
              </a>
            
              
              <a class="source" href="display.html">
                display.js
              </a>
            
              
              <a class="source" href="epub.html">
                epub.js
              </a>
            
              
              <a class="source" href="events.html">
                events.js
              </a>
            
              
              <a class="source" href="filters.html">
                filters.js
              </a>
            
              
              <a class="source" href="formatting.html">
                formatting.js
              </a>
            
              
              <a class="source" href="layout.html">
                layout.js
              </a>
            
              
              <a class="source" href="navigation.html">
                navigation.js
              </a>
            
              
              <a class="source" href="parse.html">
                parse.js
              </a>
            
              
              <a class="source" href="styles.html">
                styles.js
              </a>
            
              
              <a class="source" href="touch.html">
                touch.js
              </a>
            
              
              <a class="source" href="wrapper.html">
                wrapper.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>navigation.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-pi">'use strict'</span>;

<span class="hljs-comment">/* jshint unused: true */</span>
<span class="hljs-comment">/* exported Reader */</span>
<span class="hljs-comment">/* global $ */</span>

<span class="hljs-keyword">var</span> Reader = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(r)</span> </span>{

	r.Book.spine = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Number of chapters.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> bookChapters = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Initial chapter by default.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> chapter = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Initial page by default.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> page = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Number of pages in the actual chapter (columns number).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> pagesByChapter = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>The current location’s CFI.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> _cfi = <span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>A reference to the head node of the current chapter:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> _chapterHead = $();</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>The chapter document file name:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> chapterDocName = <span class="hljs-string">''</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Reset method for the reader.
<em>Note, some properties are not reset, such as preferences, listeners, styling</em>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	r.reset = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
		r.DOCROOT = <span class="hljs-string">''</span>;
		r.mobile = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Reset all modules.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		r.Epub.reset();
		r.Navigation.reset();
		r.Bookmarks.reset();
		r.Book.reset();</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Remove book content.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span>(r.$parent){
			r.$parent.empty();
			r.$iframe = <span class="hljs-literal">null</span>;
			r.$wrap = <span class="hljs-literal">null</span>;
			r.$head = <span class="hljs-literal">null</span>;
			r.$container = <span class="hljs-literal">null</span>;
			r.$reader = <span class="hljs-literal">null</span>;
			r.$header = <span class="hljs-literal">null</span>;
			r.$footer = <span class="hljs-literal">null</span>;
			r.$stylesheet = <span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>reset link to CSS rules</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			r.preferences.lineHeight.rules = [];
			r.preferences.fontSize.rules = [];
			r.preferences.fontFamily.rules = [];
			r.preferences.textAlign.rules = [];
			r.preferences.theme.rules = {
				background: [],
				title: [],
				color: []
			};
		}
	};

	r.getReaderOuterWidth = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
		<span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.floor(r.Layout.Reader.width + r.Layout.Reader.padding);
	};

	r.getReaderLeftPosition = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Transform value is matrix(a, c, b, d, tx, ty)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">return</span> <span class="hljs-built_in">parseInt</span>(r.$reader.css(<span class="hljs-string">'transform'</span>).split(<span class="hljs-string">','</span>)[<span class="hljs-number">4</span>], <span class="hljs-number">10</span>) || <span class="hljs-number">0</span>;
	};

	r.setReaderLeftPosition = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(pos, duration)</span> </span>{
		<span class="hljs-keyword">var</span> defer = $.Deferred();</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Force any previous transition to finish.
Calling the r.getReaderLeftPosition() getter also seems to be necessary
for the next transitionend event in some cases (e.g. the transition unit tests).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		r.$reader.css({
			<span class="hljs-string">'transition-duration'</span>: <span class="hljs-string">'0s'</span>,
			transform: <span class="hljs-string">'translateX('</span> + r.getReaderLeftPosition() + <span class="hljs-string">'px)'</span>
		}).trigger(r.support.transitionend);
		<span class="hljs-keyword">if</span> (duration) {
			r.$reader.one(r.support.transitionend, defer.resolve);
		} <span class="hljs-keyword">else</span> {
			defer.resolve();
		}
		r.$reader.css({
			<span class="hljs-string">'transition-duration'</span>: (duration || <span class="hljs-number">0</span>) + <span class="hljs-string">'s'</span>,
			transform: <span class="hljs-string">'translateX('</span> + pos + <span class="hljs-string">'px)'</span>
		});
		<span class="hljs-keyword">return</span> defer.promise();
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Return the page number in the actual chapter where it is an element.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	r.moveToAnchor = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(id)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Find the obj</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> obj = $(r.$iframe.contents()[<span class="hljs-number">0</span>].getElementById(<span class="hljs-built_in">String</span>(id)));
		<span class="hljs-keyword">if</span> (obj.length === <span class="hljs-number">0</span>) {
			<span class="hljs-keyword">return</span> <span class="hljs-number">0</span>; <span class="hljs-comment">// If the object does not exist in the chapter we send the user to the page 0 of the chapter</span>
		} <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Check if the element has children and send the first one. This is to avoid the problems with big elements, like a wrapper for all the chapter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (obj.children().length &gt; <span class="hljs-number">0</span>) {
				<span class="hljs-keyword">return</span> r.returnPageElement(obj.children().first());
			}
			<span class="hljs-keyword">return</span> r.returnPageElement(obj);
		}
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Returns the page number related to an element.
[27.11.13] Refactored how we calculate the page for an element. Since the offset is calculated relative to the reader container now, we don’t need to calculate the relative page number, only the absolute one.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	r.returnPageElement = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(obj)</span> </span>{
		obj = (obj <span class="hljs-keyword">instanceof</span> $) ? obj : $(obj, r.$iframe.contents());
		<span class="hljs-keyword">if</span> (!obj.length) {
			<span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
		}
		<span class="hljs-keyword">var</span> offset = obj.offset().left - r.$reader.offset().left;
		<span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.floor((offset) / r.getReaderOuterWidth());
	};

	<span class="hljs-keyword">var</span> _getColumnsNumber = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
		<span class="hljs-keyword">var</span> el = r.$reader[<span class="hljs-number">0</span>];
		<span class="hljs-keyword">return</span> <span class="hljs-built_in">Math</span>.ceil(el.scrollWidth / r.getReaderOuterWidth());
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Refresh the content layout.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	r.refreshLayout = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Update the number of columns</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		pagesByChapter = _getColumnsNumber();
		<span class="hljs-keyword">var</span> promise;</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Maintain reader current position</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span>(_cfi &amp;&amp; _cfi.CFI) {
			promise = r.CFI.goToCFI(_cfi.CFI, <span class="hljs-literal">true</span>);
		} <span class="hljs-keyword">else</span> {
			promise = $.Deferred().resolve().promise();
		}
		<span class="hljs-keyword">return</span> promise.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			r.Bookmarks.display();
			r.Navigation.updateProgress();
		});
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>The current book progress.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> _progress = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <h2 id="navigation-api">Navigation API</h2>
<p>The Navigation object exposes methods to allow the user to navigate within the book.</p>
<ul>
<li><code>save</code></li>
<li><code>setNumberOfChapters</code></li>
<li><code>getPage</code></li>
<li><code>setPage</code></li>
<li><code>loadPage</code></li>
<li><code>setNumberOfPagesInChapter</code></li>
<li><code>setChapter</code></li>
<li><code>getChapter</code></li>
<li><code>getChapterDocName</code></li>
<li><code>loadChapter</code></li>
<li><code>next</code></li>
<li><code>prev</code></li>
<li><code>getCFI</code></li>
<li><code>getCFIObject</code></li>
<li><code>setCFI</code></li>
<li><code>reset</code></li>
<li><code>getProgress</code></li>
<li><code>updateProgress</code></li>
<li><code>getCurrentCFI</code></li>
<li><code>updateCurrentCFI</code></li>
<li><code>update</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>
	r.Navigation = {
		save: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
			<span class="hljs-comment">/* for(var k in sLoad) { oLoad[k]=sLoad[k]; } */</span>
		},
		setNumberOfChapters: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(numberOfChapters)</span> </span>{
			bookChapters = numberOfChapters;
		},
		getNumberOfChapters: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
			<span class="hljs-keyword">return</span> Chapter.getTotal();
		},
		getPage: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> Page.get();
		},
		getPagePosition: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> -<span class="hljs-number">1</span> * r.getReaderOuterWidth() * Page.get();
		},
		getNumberOfPages: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
			<span class="hljs-keyword">return</span> Page.getByChapter();
		},
		setNumberOfPages: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Update the number of columns</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			pagesByChapter = _getColumnsNumber();
		},
		setPage: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> </span>{
			Page.set(p);
		},
		loadPage: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p, fixed)</span> </span>{
			<span class="hljs-keyword">return</span> Page.load(p, fixed);
		},
		setChapter: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c)</span></span>{
			chapter = c;</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Update the chapter doc name.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">try</span> {
				<span class="hljs-keyword">var</span> pathComponents = r.Book.spine[chapter].href.split(<span class="hljs-string">'/'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>get the last element in the array</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				chapterDocName = pathComponents.slice(-<span class="hljs-number">1</span>)[<span class="hljs-number">0</span>];
			}
			<span class="hljs-keyword">catch</span> (e) {
				<span class="hljs-built_in">console</span>.log(<span class="hljs-string">'setChapter:'</span>+e);
			}
		},
		getChapter: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
			<span class="hljs-keyword">return</span> Chapter.get();
		},
		setChapterHead: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(head)</span> </span>{
			_chapterHead = head;
		},
		getChapterHead: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> _chapterHead;
		},
		getChapterDocName: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> Chapter.getDocName();
		},
		loadChapter: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(anchorUrl)</span> </span>{
			<span class="hljs-keyword">var</span> spine = r.Book.spine,
					urlParts = anchorUrl.split(<span class="hljs-string">'#'</span>),
					url = urlParts[<span class="hljs-number">0</span>],
					anchor = urlParts[<span class="hljs-number">1</span>],
					index;
			<span class="hljs-keyword">if</span> (anchor &amp;&amp; (!url || spine[chapter].href.indexOf(url) === <span class="hljs-number">0</span>) &amp;&amp;
				!r.Navigation.isChapterPartAnchor(anchor)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>URL points to current chapter (and chapter part)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">return</span> r.Navigation.loadPage(anchor);
			}
			index = r.Book.getSpineIndex(url);
			<span class="hljs-keyword">if</span> (index !== -<span class="hljs-number">1</span>) {
				<span class="hljs-keyword">return</span> r.loadChapter(index, anchor);
			}
			<span class="hljs-keyword">return</span> $.Deferred().reject(
					$.extend({}, r.Event.ERR_INVALID_ARGUMENT, {details: <span class="hljs-string">'Specified chapter does not exist.'</span>, call: <span class="hljs-string">'loadChapter'</span>, href: anchorUrl})
			).promise();
		},
		next: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">if</span> (page &lt; pagesByChapter - <span class="hljs-number">1</span>) {
				<span class="hljs-keyword">return</span> Page.next();
			}
			<span class="hljs-keyword">var</span> defer = $.Deferred(),
					chapterPartUrl = r.Navigation.getNextChapterPartUrl(),
					loadPromise;
			<span class="hljs-keyword">if</span> (chapterPartUrl || chapter &lt; bookChapters - <span class="hljs-number">1</span>) {
				Page.moveTo(
					page + <span class="hljs-number">1</span>,
					r.preferences.transitionDuration.value
				).then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
					defer.notify({type: <span class="hljs-string">'chapter.loading'</span>});
					<span class="hljs-keyword">if</span> (chapterPartUrl) {
						loadPromise = r.Navigation.loadChapter(chapterPartUrl);
					} <span class="hljs-keyword">else</span> {
						loadPromise = Chapter.load(Chapter.next());
					}
					loadPromise.then(defer.resolve, defer.reject);
				});
			} <span class="hljs-keyword">else</span> {
				defer.reject(r.Event.END_OF_BOOK);
			}
			<span class="hljs-keyword">return</span> defer.promise();
		},
		prev: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">if</span> (page &gt; <span class="hljs-number">0</span>) {
				<span class="hljs-keyword">return</span> Page.prev();
			}
			<span class="hljs-keyword">var</span> defer = $.Deferred(),
					chapterPartUrl = r.Navigation.getPrevChapterPartUrl(),
					loadPromise;
			<span class="hljs-keyword">if</span> (chapterPartUrl || chapter &gt; <span class="hljs-number">0</span>) {
				Page.moveTo(
					page - <span class="hljs-number">1</span>,
					r.preferences.transitionDuration.value
				).then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
					defer.notify({type: <span class="hljs-string">'chapter.loading'</span>});
					<span class="hljs-keyword">if</span> (chapterPartUrl) {
						loadPromise = r.Navigation.loadChapter(chapterPartUrl);
					} <span class="hljs-keyword">else</span> {
						loadPromise = Chapter.load(Chapter.prev(), r.Navigation.getLastPageAnchorName());
					}
					loadPromise.then(defer.resolve, defer.reject);
				});
			} <span class="hljs-keyword">else</span> {
				defer.reject(r.Event.START_OF_BOOK);
			}
			<span class="hljs-keyword">return</span> defer.promise();
		},
		setCFI: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cfi, isBookmark)</span></span>{
			<span class="hljs-keyword">if</span> (!cfi) {
				cfi = r.CFI.getCFIObject();
			}
			r.CFI.setCFI(cfi, isBookmark);
		},
		reset: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
			bookChapters = <span class="hljs-number">0</span>;
			chapter = <span class="hljs-number">0</span>;
			page = <span class="hljs-number">0</span>;
			pagesByChapter = <span class="hljs-number">0</span>;
			_cfi = <span class="hljs-literal">null</span>;
			_progress = <span class="hljs-number">0</span>;
		},
		getProgress: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
			<span class="hljs-keyword">return</span> _progress;
		},
		updateProgress: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">var</span> totalWordCount = r.Book.getTotalWordCount(),
					spineItem = r.Book.spine.length &amp;&amp; r.Book.spine[chapter],</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Get the current word count from the chapter progress
(which adds one word to the number of words of previous chapters):</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					currentWordCount = spineItem ? <span class="hljs-built_in">Math</span>.round(spineItem.progress / <span class="hljs-number">100</span> * totalWordCount - <span class="hljs-number">1</span>) : <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Estimate read word count from current chapter:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			currentWordCount += spineItem ? r.Book.getWordCount(spineItem) * r.Navigation.getChapterReadFactor() : <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Calculate progress.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">var</span> progress = currentWordCount / totalWordCount * <span class="hljs-number">100</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>If the progress has a valid value (is a number) AND it is different than the current one, update it and send an event notification.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (progress !== _progress &amp;&amp; !<span class="hljs-built_in">isNaN</span>(progress)) {
				_progress = progress;</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Send notification to all listeners that the progress has been updated
r.execEvent(r.Event.PROGRESS_UPDATED);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			}

			<span class="hljs-keyword">if</span> (r.mobile) {</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Update footer and display progress.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">var</span> progressContainer = $(<span class="hljs-string">'#cpr-progress'</span>, r.$iframe.contents());
				<span class="hljs-keyword">if</span> (!progressContainer.length) {
					progressContainer = $(<span class="hljs-string">'&lt;div id="cpr-progress"&gt;&lt;/div&gt;'</span>).appendTo(r.$footer);
				}
				progressContainer.text(<span class="hljs-built_in">Math</span>.floor(_progress) + (r.sample ? <span class="hljs-string">' % of sample'</span> : <span class="hljs-string">' % read'</span>));
			}
		},
		goToProgress: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(progress)</span> </span>{
			<span class="hljs-keyword">if</span> ($.type(progress) !== <span class="hljs-string">'number'</span> || progress &gt; <span class="hljs-number">100</span> || progress &lt; <span class="hljs-number">0</span>) {
				r.Notify.error($.extend({}, r.Event.ERR_INVALID_ARGUMENT, {details: <span class="hljs-string">'Invalid progress'</span>, value: progress, call: <span class="hljs-string">'goToProgress'</span>}));
				<span class="hljs-keyword">return</span> $.Deferred().reject().promise();
			}
			<span class="hljs-keyword">var</span> targetWordCount = <span class="hljs-built_in">Math</span>.ceil(progress / <span class="hljs-number">100</span> * r.Book.getTotalWordCount()),
					wordCount = <span class="hljs-number">0</span>,
					progressFloat = <span class="hljs-number">0</span>,
					chapterWordCount,
					progressAnchor,
					i;
			<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; r.Book.spine.length; i++) {
				chapterWordCount = r.Book.getWordCount(r.Book.spine[i]);
				<span class="hljs-keyword">if</span> (wordCount + chapterWordCount &gt;= targetWordCount) {
					<span class="hljs-keyword">break</span>;
				}
				wordCount += chapterWordCount;
			}
			<span class="hljs-keyword">if</span> (chapterWordCount) {
				progressFloat = (targetWordCount - wordCount) / chapterWordCount;
			}
			progressAnchor = (progressFloat * <span class="hljs-number">100</span>) + <span class="hljs-string">'%'</span>;
			<span class="hljs-keyword">if</span> (chapter !== i || !r.Navigation.isProgressInCurrentChapterPart(progressFloat)) {
				<span class="hljs-keyword">return</span> r.loadChapter(i, progressAnchor);
			}
			<span class="hljs-keyword">return</span> r.Navigation.loadPage(progressAnchor);
		},
		getCurrentCFI: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
			<span class="hljs-keyword">return</span> _cfi;
		},
		updateCurrentCFI: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
			_cfi = r.CFI.getCFIObject();
		},
		update: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
			r.Navigation.updateCurrentCFI();
			r.Navigation.updateProgress();
			r.Bookmarks.display();
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Returns true for a progress anchor with a chapter percentage like e.g. “50%”:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		isProgressAnchor: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(anchor)</span> </span>{
			<span class="hljs-keyword">return</span> <span class="hljs-regexp">/%$/</span>.test(anchor);
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Returns a floating point number from a percentage anchor, e.g. 0.5 for “50%”:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		getProgressFromAnchor: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(anchor)</span> </span>{
			<span class="hljs-keyword">return</span> <span class="hljs-built_in">Number</span>(anchor.slice(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>)) / <span class="hljs-number">100</span>;
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Returns the page of the current chapter for the given percentage anchor:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		getProgressAnchorPage: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(anchor)</span> </span>{
			<span class="hljs-keyword">var</span> progress = r.Navigation.getProgressFromAnchor(anchor),
					totalElements,
					readElements,
					partElements;
			<span class="hljs-keyword">if</span> (r.Navigation.hasChapterParts()) {</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Adjust the progress for the current chapter part:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				totalElements = r.Navigation.getNumberOfChapterPartsElements();
				readElements = r.Navigation.getCurrentChapterPart() * r.preferences.maxChapterElements.value;
				partElements = r.Navigation.getNumberOfChapterPartElements();
				progress = (progress * totalElements - readElements) / partElements;
			}
			<span class="hljs-keyword">return</span> (<span class="hljs-built_in">Math</span>.ceil(progress * pagesByChapter) || <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>;
		},
		getLastPageAnchorName: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> <span class="hljs-string">'cpr-lastpage'</span>;
		},
		isLastPageAnchor: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(anchor)</span> </span>{
			<span class="hljs-keyword">return</span> <span class="hljs-regexp">/cpr-lastpage/</span>.test(anchor);
		},
		getChapterPartAnchorPrefix: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> <span class="hljs-string">'cpr-part'</span>;
		},
		isChapterPartAnchor: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(anchor)</span> </span>{
			<span class="hljs-keyword">return</span> <span class="hljs-regexp">/^cpr-part/</span>.test(anchor);
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Returns the number of removed elements from previous chapter parts:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		getPrevChapterPartMarker: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> r.$reader.find(<span class="hljs-string">'#cpr-subchapter-prev'</span>);
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Returns the number of removed elements from previous chapter parts:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		getNextChapterPartMarker: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> r.$reader.find(<span class="hljs-string">'#cpr-subchapter-next'</span>);
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Returns a collection of the available chapter part markers:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		getChapterPartMarkers: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> r.Navigation.getPrevChapterPartMarker().add(r.Navigation.getNextChapterPartMarker());
		},
		hasChapterParts: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> !!r.Navigation.getChapterPartMarkers().length;
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Returns the link to the next chapter part:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		getPrevChapterPartUrl: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> r.Navigation.getPrevChapterPartMarker().find(<span class="hljs-string">'a'</span>).attr(<span class="hljs-string">'href'</span>);
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Returns the link to the previous chapter part:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		getNextChapterPartUrl: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> r.Navigation.getNextChapterPartMarker().find(<span class="hljs-string">'a'</span>).attr(<span class="hljs-string">'href'</span>);
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Returns the zero based index of the current chapter part:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		getCurrentChapterPart: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> <span class="hljs-built_in">Number</span>(r.Navigation.getChapterPartMarkers().attr(<span class="hljs-string">'data-chapter-part'</span>)) || <span class="hljs-number">0</span>;
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Returns the number of parts the current chapter is split into:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		getNumberOfChapterParts: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> <span class="hljs-built_in">Number</span>(r.Navigation.getChapterPartMarkers().attr(<span class="hljs-string">'data-chapter-parts'</span>));
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>Returns the total number of elements counted for the chapter division calculation:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		getNumberOfChapterPartsElements: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> <span class="hljs-built_in">Number</span>(r.Navigation.getChapterPartMarkers().attr(<span class="hljs-string">'data-chapter-parts-elements'</span>));
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Returns the number of elements counted for the current chapter part:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		getNumberOfChapterPartElements: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> <span class="hljs-built_in">Number</span>(r.Navigation.getChapterPartMarkers().attr(<span class="hljs-string">'data-chapter-part-elements'</span>)) || r.preferences.maxChapterElements.value;
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Returns true if the given floating point progress point is in the current chapter part:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		isProgressInCurrentChapterPart: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(progress)</span> </span>{
			<span class="hljs-keyword">return</span> !r.Navigation.hasChapterParts() ||
				r.Navigation.getCurrentChapterPart() ===
					(<span class="hljs-built_in">Math</span>.ceil(r.Navigation.getNumberOfChapterPartsElements() * progress / r.preferences.maxChapterElements.value) || <span class="hljs-number">1</span>) - <span class="hljs-number">1</span>;
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Returns the chapter part based on the given CFI:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		getChapterPartFromCFI: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cfi)</span> </span>{
			<span class="hljs-keyword">var</span> maxElements = r.preferences.maxChapterElements.value,
					part = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Get the element path component of the cfi:
e.g. for epubcfi(/6/8!/4[body01]/2/402/2/1:0) get 4[body01]/2/402/2/1:0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			$.each((cfi.split(<span class="hljs-string">'!'</span>)[<span class="hljs-number">1</span>] || <span class="hljs-string">''</span>).slice(<span class="hljs-number">1</span>, -<span class="hljs-number">1</span>).split(<span class="hljs-string">'/'</span>), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key, value)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Check if the CFI is found on a later chapter part by dividing the highest
branch count through the maxelements * 2 (CFI elements always have an even index):</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">var</span> newPart = <span class="hljs-built_in">Math</span>.floor((<span class="hljs-built_in">parseInt</span>(value, <span class="hljs-number">10</span>) - <span class="hljs-number">1</span>) / (maxElements * <span class="hljs-number">2</span>));
				<span class="hljs-keyword">if</span> (newPart &gt; <span class="hljs-number">0</span>) {
					part = newPart;</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Break out of the $.each loop:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
				}
			});
			<span class="hljs-keyword">return</span> part;
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Returns true if the given CFI can be found in the current chapter part:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		isCFIInCurrentChapterPart: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cfi)</span> </span>{
			<span class="hljs-keyword">return</span> !r.Navigation.hasChapterParts() || r.Navigation.getCurrentChapterPart() === r.Navigation.getChapterPartFromCFI(cfi);
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Calculate how much of the current chapter has been read:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		getChapterReadFactor: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">var</span> factor = (page + <span class="hljs-number">1</span>) / pagesByChapter,
					totalElements,
					readElements,
					partElements;
			<span class="hljs-keyword">if</span> (r.Navigation.hasChapterParts()) {</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Factor in the previous chapter parts, as pagesByChapter only counts the current chapter part:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				totalElements = r.Navigation.getNumberOfChapterPartsElements();
				readElements = r.Navigation.getCurrentChapterPart() * r.preferences.maxChapterElements.value;
				partElements = r.Navigation.getNumberOfChapterPartElements();
				<span class="hljs-keyword">return</span> (readElements + partElements * factor) / totalElements;
			}
			<span class="hljs-keyword">return</span> factor;
		}
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Returns images in the ideal loading order:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getImagesToLoad</span><span class="hljs-params">(reverse, nearestSelector)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>nearestSelector is the selector for the element identifying the current position,
e.g. a CFI marker as data attribute selector or an element id to identify an anchor in the current document:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> nearestElement = nearestSelector &amp;&amp; $(nearestSelector, r.$reader)[<span class="hljs-number">0</span>],
				imgSelector = <span class="hljs-string">'img.cpr-placeholder'</span>,</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Both jQuery and the DOM selector API will return matching elements in DOM order.
Using this information, we combine the img selector with the nearestSelector:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				selector = nearestElement ? imgSelector + <span class="hljs-string">','</span> + nearestSelector : imgSelector,</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>As a result, we will get a collection of elements with the CFI marker or anchor in the middle:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				images = $(selector, r.$reader),
				sortedImages,
				nearestIndex,
				i,
				el;</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>If the reverse argument is set, reverse the order of the elements,
which is useful for navigating backwards in a book:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (images.length &gt; <span class="hljs-number">1</span> &amp;&amp; reverse) {
			images = $(images.get().reverse());
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>If no position element is given, simply return the collected images:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (!nearestElement) {
			<span class="hljs-keyword">return</span> images;
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Retrieve the index of the position element in the collection:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		nearestIndex = images.index(nearestElement);
		sortedImages = [];</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Add the position element itself if it’s matching the img selector:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> ($(nearestElement).is(imgSelector)) {
			sortedImages.push(nearestElement);
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Add to the new collection starting with the images closest to the position element index:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">for</span> (i = <span class="hljs-number">1</span>; sortedImages.length &lt; images.length - <span class="hljs-number">1</span>; i++) {</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Add the previous image before the position element:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			el = images[nearestIndex - i];
			<span class="hljs-keyword">if</span> (el) {
				sortedImages.push(el);
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Add the next image after the position element:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			el = images[nearestIndex + i];
			<span class="hljs-keyword">if</span> (el) {
				sortedImages.push(el);
			}
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>Return the collection of img elements sorted based on their relative distance to the given element:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">return</span> $(sortedImages);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Loads images in sequential order based on the current chapter position:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadImages</span><span class="hljs-params">(reverse, nearestSelector)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>A list to collect the images to be loaded:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> updatedImages = $(),</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Main deferred object, will be resolved once all the required images have been loaded:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				mainDefer = $.Deferred(),</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>Promise which will be used to chain the sequential image loading:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				promise = $.Deferred().resolve().promise();
		getImagesToLoad(reverse, nearestSelector).each(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">var</span> el = <span class="hljs-keyword">this</span>,
					dataSrc = el &amp;&amp; el.getAttribute(<span class="hljs-string">'data-src'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Ignore images that have no data-src (safeguard, they should not be in the collection):</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (!dataSrc) {
				<span class="hljs-keyword">return</span>;
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Chaining the promises so we only load images until the nearest pages are filled.
Since each loaded image can influence the page layout we have to load them sequentially:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			promise = promise.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>Check if the img element is within the preload range:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (<span class="hljs-built_in">Math</span>.abs(r.returnPageElement(el) - r.Navigation.getPage()) &lt;= r.preferences.preloadRange.value) {
					<span class="hljs-keyword">var</span> $el = $(el),
							defer = $.Deferred();
					$el.one(<span class="hljs-string">'load'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Remove all event handlers (load/error):</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						$el.off();</pre></div></div>
            
        </li>
        
        
        <li id="section-75">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-75">&#182;</a>
              </div>
              <p>Remove the placeholder class from the image element:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						$el.removeClass(<span class="hljs-string">'cpr-placeholder'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-76">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-76">&#182;</a>
              </div>
              <p>All images greater than 75% of the reader width or height will receive cpr-img-large class to center them:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						<span class="hljs-keyword">var</span> columnWidth = r.Layout.Reader.width / r.Layout.Reader.columns - r.Layout.Reader.padding / <span class="hljs-number">2</span>,
								columnHeight = r.Layout.Reader.height;
						<span class="hljs-keyword">if</span> (el.width &gt; <span class="hljs-number">3</span>/<span class="hljs-number">4</span> * columnWidth || el.height &gt; <span class="hljs-number">3</span>/<span class="hljs-number">4</span> * columnHeight) {
							$el.addClass(<span class="hljs-string">'cpr-img-large'</span>);
						} <span class="hljs-keyword">else</span>  <span class="hljs-keyword">if</span>(el.width &gt; <span class="hljs-number">1</span>/<span class="hljs-number">4</span> * columnWidth || el.height &gt; <span class="hljs-number">1</span>/<span class="hljs-number">4</span> * columnHeight){
							$el.addClass(<span class="hljs-string">'cpr-img-medium'</span>);
						} <span class="hljs-keyword">else</span> {
							$el.addClass(<span class="hljs-string">'cpr-img-small'</span>);
						}</pre></div></div>
            
        </li>
        
        
        <li id="section-77">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-77">&#182;</a>
              </div>
              <p>Notify on each image load:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						mainDefer.notify({type: <span class="hljs-string">'load.img'</span>, element: el});
						updatedImages = updatedImages.add(el);</pre></div></div>
            
        </li>
        
        
        <li id="section-78">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-78">&#182;</a>
              </div>
              <p>Resolve the promise for the current image:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						defer.resolve();
					});
					$el.one(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-79">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-79">&#182;</a>
              </div>
              <p>Remove all event handlers (load/error):</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						$el.off();</pre></div></div>
            
        </li>
        
        
        <li id="section-80">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-80">&#182;</a>
              </div>
              <p>Restore the data-src to allow reloading the failed image:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						el.setAttribute(<span class="hljs-string">'data-src'</span>, el.getAttribute(<span class="hljs-string">'src'</span>));</pre></div></div>
            
        </li>
        
        
        <li id="section-81">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-81">&#182;</a>
              </div>
              <p>Restore the original src with the placeholder image:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						el.setAttribute(<span class="hljs-string">'src'</span>, <span class="hljs-string">'data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=='</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-82">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-82">&#182;</a>
              </div>
              <p>Resolve the promise for the current image:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						defer.resolve();
					});</pre></div></div>
            
        </li>
        
        
        <li id="section-83">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-83">&#182;</a>
              </div>
              <p>Start the image load by using the data-src for the actual img src:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					el.setAttribute(<span class="hljs-string">'src'</span>, dataSrc);</pre></div></div>
            
        </li>
        
        
        <li id="section-84">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-84">&#182;</a>
              </div>
              <p>Remove the obsolete data-src:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					el.removeAttribute(<span class="hljs-string">'data-src'</span>);
					<span class="hljs-keyword">return</span> defer.promise();
				}
			});
		});</pre></div></div>
            
        </li>
        
        
        <li id="section-85">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-85">&#182;</a>
              </div>
              <p>This method is called after all the required images have been loaded:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolveLoadImages</span><span class="hljs-params">()</span> </span>{
			r.Filters.removeFilter(afterChapterDisplayFilter);
			mainDefer.resolve(updatedImages);
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-86">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-86">&#182;</a>
              </div>
              <p>When a new chapter is displayed, it will remove the current images on the page
and might prevent any outstanding img load events and never resolve loadImages.
Therefore we call resolveLoadImages manually after the chapter content has been replaced:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">afterChapterDisplayFilter</span> <span class="hljs-params">(content)</span> </span>{
			resolveLoadImages();
			<span class="hljs-keyword">return</span> content;
		}
		r.Filters.addFilter(r.Filters.HOOKS.AFTER_CHAPTER_DISPLAY, afterChapterDisplayFilter);
		promise.then(resolveLoadImages);
		<span class="hljs-keyword">return</span> mainDefer.promise();
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-87">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-87">&#182;</a>
              </div>
              <h2 id="page-api">Page API</h2>
<p>Actual page is contained in the variable _pageIndex.</p>
<ul>
<li><code>get</code> returns the index of the actual page.</li>
<li><code>getByChapter</code> return the total number of pages in the actual chapter.</li>
<li><code>next</code> refreshes the page variable adding one and moves to the next page (column)</li>
<li><code>prev</code> refreshes the page variable subtracting one and moves to the prev pave (column)</li>
<li><code>load</code> refreshes the page variable with a value and moves the scroll to its position</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> Page = {
		set: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span> </span>{
			page = p;
		},
		get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> page;
		},
		getByChapter: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> pagesByChapter;
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-88">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-88">&#182;</a>
              </div>
              <p>Moves to the page given as index, epubcfi, anchor or special last page anchor:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		moveTo: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(p, duration)</span> </span>{
			<span class="hljs-keyword">if</span> ($.type(p) === <span class="hljs-string">'string'</span>) {
				<span class="hljs-keyword">if</span> (r.Navigation.isLastPageAnchor(p)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-89">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-89">&#182;</a>
              </div>
              <p>jump to the last page of the chapter:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					page = pagesByChapter - <span class="hljs-number">1</span>;
				} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (r.Navigation.isProgressAnchor(p)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-90">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-90">&#182;</a>
              </div>
              <p>page is given as chapter progress, jump to the equivalent part:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					page = r.Navigation.getProgressAnchorPage(p);
				} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (r.CFI.isValidCFI(p)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-91">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-91">&#182;</a>
              </div>
              <p>page is given as CFI, jump to the page containing the CFI marker:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">var</span> pos = r.CFI.findCFIElement(p);
					page = pos === -<span class="hljs-number">1</span> ? <span class="hljs-number">0</span> : pos;
				} <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-92">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-92">&#182;</a>
              </div>
              <p>page is given as element id, jump to the page containing the element:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					page = r.moveToAnchor(p);
				}
			} <span class="hljs-keyword">else</span> {
				page = p || <span class="hljs-number">0</span>;
			}
			<span class="hljs-keyword">return</span> r.setReaderLeftPosition(-<span class="hljs-number">1</span> * r.getReaderOuterWidth() * page, duration);
		},
		next: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> Page.moveTo(
				page + <span class="hljs-number">1</span>,
				r.preferences.transitionDuration.value
			).then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
				r.Navigation.updateCurrentCFI();
				<span class="hljs-keyword">return</span> loadImages().then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(updatedImages)</span> </span>{
					<span class="hljs-keyword">if</span> (updatedImages.length) {
						r.refreshLayout();
					} <span class="hljs-keyword">else</span> {
						r.Navigation.updateProgress();
						r.Bookmarks.display();
					}
				});
			});
		},
		prev: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> Page.moveTo(
				page - <span class="hljs-number">1</span>,
				r.preferences.transitionDuration.value
			).then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
				r.Navigation.updateCurrentCFI();
				r.setReaderOpacity(<span class="hljs-number">0</span>);
				<span class="hljs-keyword">return</span> loadImages(<span class="hljs-literal">true</span>)
					.progress(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
						pagesByChapter = _getColumnsNumber();
						r.CFI.goToCFI(_cfi.CFI, <span class="hljs-literal">true</span>);
					})
					.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
						r.Navigation.updateProgress();
						r.Bookmarks.display();
						r.setReaderOpacity(<span class="hljs-number">1</span>);
					});
			});
		},
		load: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p, fixed)</span> </span>{
			<span class="hljs-keyword">var</span> isString = $.type(p) === <span class="hljs-string">'string'</span>,
				isLastPage,
				isProgressAnchor,
				selector,
				cfi;
			<span class="hljs-keyword">if</span> (isString) {
				isLastPage = r.Navigation.isLastPageAnchor(p);
				isProgressAnchor = !isLastPage &amp;&amp; r.Navigation.isProgressAnchor(p);
				<span class="hljs-keyword">if</span> (!isLastPage &amp;&amp; !isProgressAnchor) {
					<span class="hljs-keyword">if</span> (r.CFI.isValidCFI(p)) {
						selector = r.CFI.getCFISelector(p);
					} <span class="hljs-keyword">else</span> {
						selector = p;
					}
				}
			}
			Page.moveTo(p);
			<span class="hljs-keyword">if</span> (isProgressAnchor) {</pre></div></div>
            
        </li>
        
        
        <li id="section-93">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-93">&#182;</a>
              </div>
              <p>If we have a progress anchor, load images based around the new position:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				cfi = r.CFI.getCFIObject();
				selector = cfi &amp;&amp; r.CFI.getCFISelector(cfi.CFI);
			}
			<span class="hljs-keyword">var</span> promise = loadImages(isLastPage, selector)
				.progress(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-94">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-94">&#182;</a>
              </div>
              <p>Update the colums and page position on each image load:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					pagesByChapter = _getColumnsNumber();
					Page.moveTo(p);
				});
			<span class="hljs-keyword">if</span> (!fixed) {
				promise = promise.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
					r.Navigation.update();
				});
			}
			<span class="hljs-keyword">return</span> promise;
		}
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-95">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-95">&#182;</a>
              </div>
              <h2 id="chapter-api">Chapter API</h2>
<p>Chapters number is contained in the variable _bookChapters.
Chapter index is controlled with the _bookChapter variable.</p>
<ul>
<li><code>get</code> returns the index of the actual chapter (_bookChapter)</li>
<li><code>getTotal</code> returns the total number of pages in the actual chapter.</li>
<li><code>next</code> refresh the index variable adding one.</li>
<li><code>prev</code> refresh the index variable subtracting one.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> Chapter = {
		get: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> </span>{
			<span class="hljs-keyword">if</span> (callback &amp;&amp; <span class="hljs-keyword">typeof</span>(callback) === <span class="hljs-string">'function'</span>) { callback(); }
			<span class="hljs-keyword">return</span> chapter;
		},
		getDocName: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> </span>{
			<span class="hljs-keyword">if</span> (callback &amp;&amp; <span class="hljs-keyword">typeof</span>(callback) === <span class="hljs-string">'function'</span>) { callback(); }
			<span class="hljs-keyword">return</span> chapterDocName;
		},
		getTotal: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(callback)</span> </span>{
			<span class="hljs-keyword">if</span> (callback &amp;&amp; <span class="hljs-keyword">typeof</span>(callback) === <span class="hljs-string">'function'</span>) { callback(); }
			<span class="hljs-keyword">return</span> bookChapters;
		},
		next: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> ++chapter;
		},
		prev: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> --chapter;
		},
		load: <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c, p)</span> </span>{
			<span class="hljs-keyword">return</span> r.loadChapter(c, p);
		}
	};

	<span class="hljs-keyword">return</span> r;

}(Reader || {}));</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
