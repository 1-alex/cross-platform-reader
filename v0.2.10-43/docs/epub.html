<!DOCTYPE html>

<html>
<head>
  <title>epub.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="book.html">
                book.js
              </a>
            
              
              <a class="source" href="bookdata.html">
                bookdata.js
              </a>
            
              
              <a class="source" href="cfi.html">
                cfi.js
              </a>
            
              
              <a class="source" href="config.html">
                config.js
              </a>
            
              
              <a class="source" href="display.html">
                display.js
              </a>
            
              
              <a class="source" href="epub.html">
                epub.js
              </a>
            
              
              <a class="source" href="events.html">
                events.js
              </a>
            
              
              <a class="source" href="filters.html">
                filters.js
              </a>
            
              
              <a class="source" href="formatting.html">
                formatting.js
              </a>
            
              
              <a class="source" href="layout.html">
                layout.js
              </a>
            
              
              <a class="source" href="navigation.html">
                navigation.js
              </a>
            
              
              <a class="source" href="parse.html">
                parse.js
              </a>
            
              
              <a class="source" href="styles.html">
                styles.js
              </a>
            
              
              <a class="source" href="touch.html">
                touch.js
              </a>
            
              
              <a class="source" href="wrapper.html">
                wrapper.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>epub.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-pi">'use strict'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Helper methods:</p>
<ul>
<li><a href="#updateContext"><code>updateContext</code></a></li>
<li><a href="#addContext"><code>addContext</code></a></li>
<li><a href="#removeContext"><code>removeContext</code></a></li>
<li><a href="#normalizeChapterPartCFI"><code>normalizeChapterPartCFI</code></a></li>
<li><a href="#addOneNodeToCFI"><code>addOneNodeToCFI</code></a></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> Reader = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(r, Epub)</span> </span>{
	r.Epub = <span class="hljs-keyword">new</span> Epub();
	<span class="hljs-keyword">return</span> r;
}(Reader || {}, (<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(r, EPUBcfi)</span></span>{

		<span class="hljs-keyword">var</span> Epub = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
			<span class="hljs-keyword">this</span>.context = <span class="hljs-literal">null</span>;
			<span class="hljs-keyword">this</span>.opfCFI = <span class="hljs-literal">null</span>;
			<span class="hljs-keyword">this</span>.document = <span class="hljs-literal">null</span>;
		}, prototype = Epub.prototype;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Private array for blacklisted classes. The CFI library will ignore any DOM elements that have these classes.
<a href="https://github.com/readium/EPUBCFI/blob/864527fbb2dd1aaafa034278393d44bba27230df/spec/javascripts/cfi_instruction_spec.js#L137">Read more</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		prototype.BLACKLIST = [<span class="hljs-string">'cpr-marker'</span>, <span class="hljs-string">'cpr-subchapter-link'</span>];
		prototype.DOT_REGEX = <span class="hljs-regexp">/\[([\w-_])*\.([\w-_])*\]/gi</span>;
		prototype.BODY_CFI = <span class="hljs-string">'!/4'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Initialisation function, called when the reader is initialised.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		prototype.init = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(reader)</span></span>{
			<span class="hljs-keyword">var</span> elCFI = EPUBcfi.Generator.generateElementCFIComponent(reader);

			<span class="hljs-keyword">this</span>.document = reader.ownerDocument;
			<span class="hljs-keyword">this</span>.context = elCFI.substring(<span class="hljs-number">2</span>); <span class="hljs-comment">// remove the body cfi step, i.e. /4</span>
		};</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p><a name="setUp"></a> Initialises the CFI variables, should be called whenever we load a new chapter
<code>chapter</code> the current chapter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		prototype.setUp = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(chapter, $opf)</span></span>{
			<span class="hljs-keyword">var</span> chapterId = $opf.find(<span class="hljs-string">'spine'</span>).children()[chapter].getAttribute(<span class="hljs-string">'idref'</span>);
			<span class="hljs-keyword">this</span>.opfCFI = EPUBcfi.Generator.generatePackageDocumentCFIComponent(chapterId, $opf[<span class="hljs-number">0</span>]);
		};</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p><a name="_clean"></a> This function will sanitize a cfi (removed dots from ID assertion)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		prototype.cleanCFI = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cfi)</span></span>{
			<span class="hljs-keyword">return</span> cfi.replace(<span class="hljs-keyword">this</span>.DOT_REGEX, <span class="hljs-string">''</span>);
		};</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p><a name="addContext"></a> This function will add the context into a CFI to generate a complete and valid CFI to be used with the current chapter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		prototype.addContext = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cfi)</span></span>{
			<span class="hljs-keyword">var</span> contextSplit = cfi.split(<span class="hljs-keyword">this</span>.BODY_CFI);
			<span class="hljs-keyword">return</span> contextSplit[<span class="hljs-number">0</span>] + <span class="hljs-keyword">this</span>.BODY_CFI + <span class="hljs-keyword">this</span>.context + contextSplit[<span class="hljs-number">1</span>];
		};</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p><a name="removeContext"></a> This function will remove the context from a CFI to generate a re-usable, generic, CFI.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		prototype.removeContext = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cfi)</span></span>{
			<span class="hljs-keyword">return</span> cfi.replace(<span class="hljs-keyword">this</span>.context, <span class="hljs-string">''</span>);
		};</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p><a name="normalizeChapterPartCFI"></a> This function normalizes CFI parts to account for chapters which have been split up into multiple parts.
todo this method is the only dependency on global Reader object, consider refactoring
move getPrevChapterPartMarker and stuff to Epub</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		prototype.normalizeChapterPartCFI = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(cfi, remove)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Check if the chapter has been split up into multiple parts:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">var</span> prevChapterPartMarker = r.Navigation.getPrevChapterPartMarker();
			<span class="hljs-keyword">if</span> (prevChapterPartMarker.length) {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Get the CFI path for the first non-removed element:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">var</span> chapterMarkerCFI = EPUBcfi.Generator.generateElementCFIComponent(prevChapterPartMarker.next()[<span class="hljs-number">0</span>], <span class="hljs-keyword">this</span>.BLACKLIST),
					chapterMarkerCompleteCFI = EPUBcfi.Generator.generateCompleteCFI(<span class="hljs-keyword">this</span>.opfCFI, chapterMarkerCFI),
					markerCFIParts = chapterMarkerCompleteCFI.split(<span class="hljs-string">'/'</span>),
					completeCFIParts = cfi.split(<span class="hljs-string">'/'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Check if the elCFI path points to a location inside of the set of reduced chapter part elements:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (markerCFIParts.slice(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>).join(<span class="hljs-string">'/'</span>) === completeCFIParts.slice(<span class="hljs-number">0</span>, markerCFIParts.length - <span class="hljs-number">1</span>).join(<span class="hljs-string">'/'</span>)) {
					<span class="hljs-keyword">var</span> removedElements = r.Navigation.getCurrentChapterPart() * r.preferences.maxChapterElements.value,</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>The incorrect path value, as it doesn’t account for the removed elements:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						elPathValue = <span class="hljs-built_in">parseInt</span>(completeCFIParts[markerCFIParts.length - <span class="hljs-number">1</span>], <span class="hljs-number">10</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Get the optional path suffix like any ids:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						pathSuffix = completeCFIParts[markerCFIParts.length - <span class="hljs-number">1</span>].slice(<span class="hljs-built_in">String</span>(elPathValue).length);</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Update the path value with the number of removed elements * 2 (CFI elements always have an even index):</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					completeCFIParts[markerCFIParts.length - <span class="hljs-number">1</span>] = (elPathValue + (removedElements * <span class="hljs-number">2</span> * (remove ? -<span class="hljs-number">1</span> : <span class="hljs-number">1</span>))) + pathSuffix;
					<span class="hljs-keyword">return</span> completeCFIParts.join(<span class="hljs-string">'/'</span>);
				}
			}
			<span class="hljs-keyword">return</span> cfi;
		};</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Gets the element targetted by a CFI</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		prototype.getElementAt = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cfi)</span></span>{

			cfi = <span class="hljs-keyword">this</span>.cleanCFI(cfi);
			cfi = <span class="hljs-keyword">this</span>.addContext(cfi);
			cfi = <span class="hljs-keyword">this</span>.normalizeChapterPartCFI(cfi, <span class="hljs-literal">true</span>);

			<span class="hljs-keyword">return</span> $(EPUBcfi.Interpreter.getTargetElement(cfi, <span class="hljs-keyword">this</span>.document, <span class="hljs-keyword">this</span>.BLACKLIST));
		};</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Generates the CFI that targets the given element</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		prototype.generateCFI = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(el, offset)</span></span>{
			<span class="hljs-keyword">var</span> cfi;

			<span class="hljs-keyword">if</span> (el.nodeType === <span class="hljs-number">3</span>) {
				cfi = EPUBcfi.Generator.generateCharacterOffsetCFIComponent(el, offset || <span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>.BLACKLIST);
			} <span class="hljs-keyword">else</span> {
				cfi = EPUBcfi.Generator.generateElementCFIComponent(el, <span class="hljs-keyword">this</span>.BLACKLIST);
			}

			cfi = EPUBcfi.Generator.generateCompleteCFI(<span class="hljs-keyword">this</span>.opfCFI, cfi);

			cfi = <span class="hljs-keyword">this</span>.cleanCFI(cfi);
			cfi = <span class="hljs-keyword">this</span>.normalizeChapterPartCFI(cfi);
			cfi = <span class="hljs-keyword">this</span>.removeContext(cfi);

			<span class="hljs-keyword">return</span> cfi;
		};</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Injects a marker in the specified position</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		prototype.injectMarker = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(cfi, marker)</span></span>{
			cfi = <span class="hljs-keyword">this</span>.cleanCFI(cfi);
			cfi = <span class="hljs-keyword">this</span>.addContext(cfi);
			cfi = <span class="hljs-keyword">this</span>.normalizeChapterPartCFI(cfi, <span class="hljs-literal">true</span>);
			EPUBcfi.Interpreter.injectElement(cfi, r.$iframe.contents()[<span class="hljs-number">0</span>], marker, <span class="hljs-keyword">this</span>.BLACKLIST);
		};

		prototype.reset = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span></span>{
			<span class="hljs-keyword">this</span>.opfCFI = <span class="hljs-literal">null</span>;
			<span class="hljs-keyword">this</span>.context = <span class="hljs-literal">null</span>;
		};

		<span class="hljs-keyword">return</span> Epub;
	})(Reader || {}, EPUBcfi)));</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
