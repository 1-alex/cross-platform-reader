<!DOCTYPE html>

<html>
<head>
  <title>display.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="bookdata.html">
                bookdata.js
              </a>
            
              
              <a class="source" href="cfi.html">
                cfi.js
              </a>
            
              
              <a class="source" href="config.html">
                config.js
              </a>
            
              
              <a class="source" href="display.html">
                display.js
              </a>
            
              
              <a class="source" href="events.html">
                events.js
              </a>
            
              
              <a class="source" href="formatting.html">
                formatting.js
              </a>
            
              
              <a class="source" href="navigation.html">
                navigation.js
              </a>
            
              
              <a class="source" href="parse.html">
                parse.js
              </a>
            
              
              <a class="source" href="styles.html">
                styles.js
              </a>
            
              
              <a class="source" href="wrapper.html">
                wrapper.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>display.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-comment">/**
 * ReaderJS v1.0.0
 * (c) 2013 BlinkboxBooks
 * display.js: methods for create the container and display the content
 */</span>

<span class="hljs-comment">/* jshint unused: true */</span>
<span class="hljs-comment">/* exported Reader */</span>
<span class="hljs-comment">/* globals $, Bugsense */</span>

<span class="hljs-keyword">var</span> Reader = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(r)</span> {</span>
<span class="hljs-pi">	'use strict'</span>;

	<span class="hljs-keyword">var</span> _initCFI = <span class="hljs-literal">null</span>, _initURL = <span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p><strong>Init function</strong></p>
<p>Assign parameters to the global variables.</p>
<ul>
<li><code>param</code> Contains the parameters: container (id), chapters, padding, url, mobile, dimensions (width and height) etc.</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>	r.init = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(param)</span> {</span>
		r.reset(); <span class="hljs-comment">// Reset the reader values.</span>
		<span class="hljs-keyword">if</span> (!param) { param = {}; }
		_initCFI = <span class="hljs-literal">null</span>;
		_initURL = <span class="hljs-literal">null</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Take the params {container, chapters, width, height, padding, _mobile} or create them.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		r.$reader = param.hasOwnProperty(<span class="hljs-string">'container'</span>) &amp;&amp; $(param.container).length ? $(param.container) : $(<span class="hljs-string">'&lt;div id="reader_container"&gt;&lt;/div&gt;'</span>).appendTo(document.body);
		r.$container = r.$reader.empty().wrap($(<span class="hljs-string">'&lt;div&gt;&lt;/div&gt;'</span>)).parent().wrap($(<span class="hljs-string">'&lt;div id="'</span> + (r.$reader[<span class="hljs-number">0</span>].id + <span class="hljs-string">'_wrap'</span>) + <span class="hljs-string">'"&gt;&lt;/div&gt;'</span>).css(<span class="hljs-string">'display'</span>, <span class="hljs-string">'inline-block'</span>));

		r.$header = $(<span class="hljs-string">'&lt;div id="cpr-header"&gt;&lt;/div&gt;'</span>).insertBefore(r.$container);
		r.$footer = $(<span class="hljs-string">'&lt;div id="cpr-footer"&gt;&lt;/div&gt;'</span>).insertAfter(r.$container);

    $(<span class="hljs-string">'&lt;span id="cpr-bookmark-ui"&gt;&lt;/span&gt;'</span>).insertAfter(r.$container); <span class="hljs-comment">// Add bookmark mark</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>add styles and fonts</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		_addStyles();

		r.listener = (param.hasOwnProperty(<span class="hljs-string">'listener'</span>)) ? param.listener : <span class="hljs-literal">null</span>;

		r.DOCROOT = (param.hasOwnProperty(<span class="hljs-string">'url'</span>)) ? param.url : <span class="hljs-string">''</span>;
		r.ISBN = (param.hasOwnProperty(<span class="hljs-string">'isbn'</span>)) ? param.isbn : <span class="hljs-string">''</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>Set the mobile flag.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		r.mobile = !!((param.hasOwnProperty(<span class="hljs-string">'mobile'</span>)));</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Save the initial bookmarks.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		r.Bookmarks.setBookmarks((param.hasOwnProperty(<span class="hljs-string">'bookmarks'</span>)) ? param.bookmarks : [], <span class="hljs-literal">true</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Set the initial position.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		_initCFI = param.hasOwnProperty(<span class="hljs-string">'initCFI'</span>) ? param.initCFI : _initCFI;
		_initURL = param.hasOwnProperty(<span class="hljs-string">'initURL'</span>) ? param.initURL : _initURL;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Resize the container with the width and height (if they exist).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		_createContainer(param.width, param.height, param.columns, param.padding);</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Apply all user preferences</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		r.setPreferences(param.preferences);

		r.resizeContainer(param);</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Enable bugsense reporting</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		_setBugsense();</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Start the party.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">return</span> loadInfo();
	};

	<span class="hljs-keyword">var</span> _addStyles= <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
		<span class="hljs-keyword">var</span> $head = $(<span class="hljs-string">'head'</span>);
		r.$stylesheet = $(<span class="hljs-string">'&lt;style id="cpr-stylesheet"&gt;'</span> +
			<span class="hljs-string">'@@readerStyles'</span>.replace(<span class="hljs-regexp">/#wrap_id/g</span>, <span class="hljs-string">'#'</span> + r.$reader.attr(<span class="hljs-string">'id'</span>) + <span class="hljs-string">'_wrap'</span>).replace(<span class="hljs-regexp">/#id/g</span>, <span class="hljs-string">'#'</span> + r.$reader.attr(<span class="hljs-string">'id'</span>)) +
			<span class="hljs-string">'&lt;/style&gt;'</span>).appendTo($head);</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Save a reference for each style</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> rules = r.$stylesheet[<span class="hljs-number">0</span>].sheet.cssRules;
		<span class="hljs-keyword">var</span> i= <span class="hljs-number">0</span>, l= rules.length, wrap_id = <span class="hljs-string">'#'</span> + r.$reader.attr(<span class="hljs-string">'id'</span>) + <span class="hljs-string">'_wrap'</span>, id = wrap_id + <span class="hljs-string">' #'</span> + r.$reader.attr(<span class="hljs-string">'id'</span>);
    <span class="hljs-keyword">var</span> _checkSelectors = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(v)</span> {</span> <span class="hljs-keyword">if</span> (rule.selectorText) { <span class="hljs-keyword">return</span> rule.selectorText.indexOf(v) &gt;= <span class="hljs-number">0</span>; }};
		<span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt; l; i++){
			<span class="hljs-keyword">var</span> rule = rules[i];
      <span class="hljs-keyword">var</span> selectors = [id +<span class="hljs-string">' *'</span>, id+<span class="hljs-string">' span'</span>, id+<span class="hljs-string">' p'</span>, id+<span class="hljs-string">' em'</span>, id+<span class="hljs-string">' div'</span>, id+<span class="hljs-string">' strong'</span>, id+<span class="hljs-string">' a'</span>, id+<span class="hljs-string">' h1'</span>, id+<span class="hljs-string">' h2'</span>, id+<span class="hljs-string">' h3'</span>, id+<span class="hljs-string">' h4'</span>, id+<span class="hljs-string">' h5'</span>, id+<span class="hljs-string">' h6'</span>];
      <span class="hljs-keyword">if</span>(selectors.every(_checkSelectors)){
				r.preferences.lineHeight.rules.push({rule: rule.style, property: <span class="hljs-string">'lineHeight'</span>});
				r.preferences.fontSize.rules.push({rule: rule.style, property: <span class="hljs-string">'fontSize'</span>});
				r.preferences.fontFamily.rules.push({rule: rule.style, property: <span class="hljs-string">'fontFamily'</span>});
				r.preferences.textAlign.rules.push({rule: rule.style, property: <span class="hljs-string">'textAlign'</span>});
				r.preferences.theme.rules.color.push({rule: rule.style, property: <span class="hljs-string">'color'</span>});
			} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(rule.selectorText === wrap_id){
				r.preferences.theme.rules.background.push({rule: rule.style, property: <span class="hljs-string">'background'</span>});
			} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(rule.selectorText === <span class="hljs-string">'#cpr-header'</span> || rule.selectorText === <span class="hljs-string">'#cpr-footer'</span>){
				r.preferences.theme.rules.title.push({rule: rule.style, property: <span class="hljs-string">'color'</span>});
			} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(rule.selectorText === <span class="hljs-string">'#cpr-bookmark-ui::before'</span>){
				r.preferences.theme.rules.background.push({rule: rule.style, property: <span class="hljs-string">'borderBackground'</span>});
			}
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Note, this is injected regardless if it exists or not</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span>(!r.mobile){
			$head.append(<span class="hljs-string">'&lt;link href=\'//fonts.googleapis.com/css?family=Droid+Serif:400,700,700italic,400italic\' rel=\'stylesheet\' type=\'text/css\'&gt;'</span>);
		}
	};

	<span class="hljs-keyword">var</span> _setBugsense = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> Bugsense === <span class="hljs-string">'function'</span>) {
			r.Bugsense = <span class="hljs-keyword">new</span> Bugsense({
				apiKey: <span class="hljs-string">'f38df951'</span>,
				appName: <span class="hljs-string">'CPR'</span>,
				appversion: <span class="hljs-string">'@@readerVersion'</span>
			});</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Setup error handler</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			window.onerror = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(message, url, line)</span> {</span>
				r.Notify.error(message, url, line);
				<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
			};
		}
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>helper function that strips the last path from the url
Ex: a/b/c.html -&gt; a/b</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> _removeLastPath = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(url)</span>{</span>
		<span class="hljs-keyword">var</span> pathSeparatorIndex = url.lastIndexOf(<span class="hljs-string">'/'</span>);
		<span class="hljs-keyword">return</span> pathSeparatorIndex !== -<span class="hljs-number">1</span> ? url.substring(<span class="hljs-number">0</span>, pathSeparatorIndex) : url;
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Function to transform relative links
ex: <code>../html/chapter.html</code> -&gt; <code>chapter.html</code></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> _normalizeLink = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(url)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>get current chapter folder url</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> chapter = r.Navigation.getChapter(), chapterURL = _removeLastPath(r.SPINE[chapter].href), result = chapterURL;</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>parse current url to remove <code>..</code> from path</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> paths = url.split(<span class="hljs-string">'/'</span>);
		<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, l = paths.length; i &lt; l; i++){
			<span class="hljs-keyword">var</span> path = paths[i];
			<span class="hljs-keyword">if</span>(path === <span class="hljs-string">'..'</span>){
				result = _removeLastPath(result);
			} <span class="hljs-keyword">else</span> {
				result += <span class="hljs-string">'/'</span> + path;
			}
		}
		<span class="hljs-keyword">return</span> result;
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Check and load an URL if it is in the spine or the TOC.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> _checkURL = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(url)</span> {</span>
		<span class="hljs-keyword">var</span> findURL = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>The URL.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> u = _normalizeLink(url[<span class="hljs-number">0</span>]);</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>The anchor.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> a = url[<span class="hljs-number">1</span>];</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Link is in the actual chapter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> chapter = r.Navigation.getChapter();
		<span class="hljs-keyword">if</span> ((r.SPINE[chapter].href.indexOf(u) !== -<span class="hljs-number">1</span> || u === <span class="hljs-string">''</span>) &amp;&amp; a !==<span class="hljs-string">''</span>) {
			r.Navigation.loadPage(r.moveToAnchor(a));
			<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Check the table of contents…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>; i&lt;r.TOC.length; i++) {
			<span class="hljs-keyword">if</span> (r.TOC[i].href.indexOf(u) !== -<span class="hljs-number">1</span> &amp;&amp; r.TOC[i].active === <span class="hljs-literal">true</span>) { findURL = <span class="hljs-literal">true</span>; }
		}

		<span class="hljs-keyword">var</span> _load = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(j,a)</span>{</span>
			r.Notify.event(r.Event.LOADING_STARTED);
			r.loadAnchor.apply(r, [j,a]).always(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clickLoadComplete</span><span class="hljs-params">()</span>{</span>
				r.Notify.event(r.Event.LOADING_COMPLETE);
			}).then(
				<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clickLoadSuccess</span><span class="hljs-params">()</span>{</span>
					r.Notify.event($.extend({}, Reader.Event.getStatus(), {call: <span class="hljs-string">'clickLoad'</span>}));
				},
				<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clickLoadError</span><span class="hljs-params">(err)</span>{</span>
					r.Notify.error(err);
				}
			);
		};</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Check the spine…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j=<span class="hljs-number">0</span>; j&lt;r.SPINE.length;j++) {</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>URL is in the Spine and it has a chapter number…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (r.SPINE[j].href.indexOf(u) !== -<span class="hljs-number">1</span>) {
				r.Navigation.setChapter(j);
				r.Navigation.setPage(<span class="hljs-number">0</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>since this is a user generated even, we must handle callbacks here</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				_load(j,a);
				<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
			}
		}
		<span class="hljs-keyword">return</span> findURL;
	};

	<span class="hljs-keyword">var</span> _touchTimer, _touchData = {
		call: <span class="hljs-string">'userClick'</span>,
		clientX: <span class="hljs-literal">null</span>,
		clientY: <span class="hljs-literal">null</span>
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>For mobile devices, notify the client of any touch events that happen on the reader (that are not links)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> _touchStartHandler = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span>{</span>
		<span class="hljs-keyword">if</span>($(e.target).is(<span class="hljs-string">':not(a)'</span>)){
			_touchTimer = (<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()).getTime();
			_touchData.clientX = e.touches ? e.touches[<span class="hljs-number">0</span>].clientX : <span class="hljs-literal">null</span>;
			_touchData.clientY = e.touches ? e.touches[<span class="hljs-number">0</span>].clientY : <span class="hljs-literal">null</span>;
		}
	};

	<span class="hljs-keyword">var</span> _touchEndHandler = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(e)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>if the difference between touchstart and touchend is smalller than 300ms, send the callback, otherwise it’s a long touch event</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span>((<span class="hljs-keyword">new</span> <span class="hljs-built_in">Date</span>()).getTime() - _touchTimer &lt; <span class="hljs-number">300</span> &amp;&amp; $(e.target).is(<span class="hljs-string">':not(a)'</span>)){
			r.Notify.event($.extend({}, Reader.Event.UNHANDLED_TOUCH_EVENT, _touchData));
		}
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Capture all the links in the reader</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> _clickHandler = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(e)</span> {</span>
		e.preventDefault();
		<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.getAttribute(<span class="hljs-string">'data-link-type'</span>) === <span class="hljs-string">'external'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>External link, notify client about it</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			r.Notify.event($.extend({}, Reader.Event.NOTICE_EXT_LINK, {call: <span class="hljs-string">'userClick'</span>, href:<span class="hljs-keyword">this</span>.getAttribute(<span class="hljs-string">'href'</span>)}));
		} <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.getAttribute(<span class="hljs-string">'data-link-type'</span>) === <span class="hljs-string">'internal'</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Internal link
Reduce the URL to the name file (remove anchors ids)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">var</span> url = <span class="hljs-keyword">this</span>.getAttribute(<span class="hljs-string">'href'</span>).split(<span class="hljs-string">'#'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Check if the link exists in the spine and ask the user</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (!_checkURL(url)) {
				r.Notify.event($.extend({}, Reader.Event.CONTENT_NOT_AVAILABLE, {call: <span class="hljs-string">'userClick'</span>}));
			}
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Stop event propagation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (e.stopPropagation) { e.stopPropagation(); }
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Display HTML content</p>
<ul>
<li><code>param</code> Contains the parameters: content, page and mimetype</li>
<li><code>callback</code> Function to be called after the function’s logic</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> displayContent = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(param)</span> {</span>
		<span class="hljs-keyword">var</span> defer = $.Deferred();

		<span class="hljs-keyword">if</span> (!param) { param = []; }</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Take the params values</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> content = (param.hasOwnProperty(<span class="hljs-string">'content'</span>)) ? param.content : <span class="hljs-string">''</span>;
		<span class="hljs-keyword">var</span> mimetype = (param.hasOwnProperty(<span class="hljs-string">'mimetype'</span>)) ? param.mimetype : <span class="hljs-string">'application/xhtml+xml'</span>;

		r.$header.text(r.bookTitle); <span class="hljs-comment">// TODO Do not polute the reader object.</span></pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Parse the content according its mime-type</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		content = r.parse(content, mimetype);
		r.$reader.html(content);</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Wait for the images and build the container</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> $images = $(<span class="hljs-string">'#'</span> + r.$reader[<span class="hljs-number">0</span>].id + <span class="hljs-string">' img'</span>);
		<span class="hljs-keyword">var</span> counter = <span class="hljs-number">0</span>, i = <span class="hljs-number">0</span>;
		<span class="hljs-keyword">var</span> timer = setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>

			<span class="hljs-keyword">if</span> (counter &gt;= $images.length) {
				clearInterval(timer);

				<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; $images.length; i++) {
					<span class="hljs-keyword">var</span> $image = $($images[i]);</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>All images greater than 75% of the reader width will receive cpr-center class to center them</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">if</span>($image.width() &gt; <span class="hljs-number">3</span>/<span class="hljs-number">4</span>*(r.Layout.Reader.width / r.Layout.Reader.columns - r.Layout.Reader.padding / <span class="hljs-number">2</span>)){
						$image.addClass(<span class="hljs-string">'cpr-center'</span>);
					}
				}

				_resizeImages();

				defer.resolve();
				<span class="hljs-keyword">return</span>;
			}

			<span class="hljs-keyword">var</span> tempCounter = <span class="hljs-number">0</span>;
			<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; $images.length; i++) {
				<span class="hljs-keyword">if</span> ($images[i].complete === <span class="hljs-literal">true</span>) {
					tempCounter++;
				}
			}
			counter = tempCounter;
		}, <span class="hljs-number">100</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Add all bookmarks for this chapter.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> bookmarks = r.Bookmarks.getBookmarks()[r.Navigation.getChapter()];
		<span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span>(bookmarks) !== <span class="hljs-string">'undefined'</span>){
			$.each(bookmarks, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(index, bookmark)</span>{</span>
				r.Navigation.setCFI(bookmark);
			});
		}

		<span class="hljs-keyword">return</span> defer.promise();
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Define the container dimensions and create the multi column or adjust the height for the vertical scroll.</p>
<ul>
<li><code>width</code> In pixels</li>
<li><code>height</code> In pixels</li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> _createContainer = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
		r.$reader.addClass(areColumnsSupported() ? <span class="hljs-string">'columns'</span> : <span class="hljs-string">'scroll'</span>);

		r.$reader.css({
			position: <span class="hljs-string">'absolute'</span>,
			left: <span class="hljs-number">0</span>,
			top: <span class="hljs-number">0</span>
		});</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Container parent styles.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		r.$container
			.css({
				overflow: <span class="hljs-string">'hidden'</span>,
				position: <span class="hljs-string">'relative'</span>,
				top: <span class="hljs-number">0</span>,
				left: <span class="hljs-number">0</span>
			});</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Capture the anchor links into the content</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		r.$container.on(<span class="hljs-string">'click'</span>, <span class="hljs-string">'a'</span>, _clickHandler);</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>Set touch handler for mobile clients, to send back the coordinates of the click</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span>(r.mobile){
			document.removeEventListener(<span class="hljs-string">'touchstart'</span>, _touchStartHandler);
			document.addEventListener(<span class="hljs-string">'touchstart'</span>, _touchStartHandler);
			document.removeEventListener(<span class="hljs-string">'touchend'</span>, _touchEndHandler);
			document.addEventListener(<span class="hljs-string">'touchend'</span>, _touchEndHandler);
		}
	};

	r.resizeContainer = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(dimensions)</span>{</span>

		dimensions = angular.extend({
			width: r.Layout.Container.width,
			height: r.Layout.Container.height,
			columns: r.Layout.Reader.columns,
			padding: r.Layout.Reader.padding
		}, dimensions);</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Save new values.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		r.Layout.Container.width = <span class="hljs-built_in">Math</span>.floor(dimensions.width);
		r.Layout.Container.height = <span class="hljs-built_in">Math</span>.floor(dimensions.height);
		r.Layout.Reader.width = r.Layout.Container.width - <span class="hljs-built_in">Math</span>.floor(r.preferences.margin.value[<span class="hljs-number">1</span>]*r.Layout.Container.width/<span class="hljs-number">100</span>) - <span class="hljs-built_in">Math</span>.floor(r.preferences.margin.value[<span class="hljs-number">3</span>]*r.Layout.Container.width/<span class="hljs-number">100</span>);
		r.Layout.Reader.height = r.Layout.Container.height - <span class="hljs-built_in">Math</span>.floor(r.preferences.margin.value[<span class="hljs-number">0</span>]*r.Layout.Container.height/<span class="hljs-number">100</span>) - <span class="hljs-built_in">Math</span>.floor(r.preferences.margin.value[<span class="hljs-number">2</span>]*r.Layout.Container.height/<span class="hljs-number">100</span>);
		r.Layout.Reader.columns = dimensions.columns;
		r.Layout.Reader.padding = dimensions.columns &gt; <span class="hljs-number">1</span> ? dimensions.padding : r.Layout.Reader.padding; <span class="hljs-comment">// only set padding on multi-column layout</span></pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>avoid rounding errors, adjust the width of the reader to contain the columns + padding</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> columnWidth = <span class="hljs-built_in">Math</span>.floor(r.Layout.Reader.width / r.Layout.Reader.columns - r.Layout.Reader.padding / <span class="hljs-number">2</span>);
		r.Layout.Reader.width = columnWidth * r.Layout.Reader.columns + (r.Layout.Reader.columns - <span class="hljs-number">1</span>) * r.Layout.Reader.padding;</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Apply new size</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		r.$reader.css({
			left: <span class="hljs-string">'-'</span> + ((<span class="hljs-built_in">Math</span>.floor(r.Layout.Reader.width + r.Layout.Reader.padding)) * (r.Navigation.getPage())) + <span class="hljs-string">'px'</span>,
			width: r.Layout.Reader.width + <span class="hljs-string">'px'</span>,
			height: r.Layout.Reader.height + <span class="hljs-string">'px'</span>,
			<span class="hljs-string">'column-width'</span>: columnWidth + <span class="hljs-string">'px'</span>,
			<span class="hljs-string">'column-gap'</span>: r.Layout.Reader.padding + <span class="hljs-string">'px'</span>,
			<span class="hljs-string">'column-fill'</span>: <span class="hljs-string">'auto'</span>
		});

		r.$container.css({
			width: r.Layout.Reader.width + <span class="hljs-string">'px'</span>,
			height: r.Layout.Reader.height + <span class="hljs-string">'px'</span>,
			<span class="hljs-string">'margin-left'</span>: <span class="hljs-built_in">Math</span>.floor(r.preferences.margin.value[<span class="hljs-number">3</span>] * r.Layout.Container.width/<span class="hljs-number">100</span>) + <span class="hljs-string">'px'</span>,
			<span class="hljs-string">'margin-right'</span>: <span class="hljs-built_in">Math</span>.floor(r.preferences.margin.value[<span class="hljs-number">1</span>] * r.Layout.Container.width/<span class="hljs-number">100</span>) + <span class="hljs-string">'px'</span>
		});

		r.$header.css({
			width: r.Layout.Reader.width + <span class="hljs-string">'px'</span>,
			<span class="hljs-string">'margin-left'</span>: <span class="hljs-built_in">Math</span>.floor(r.preferences.margin.value[<span class="hljs-number">3</span>] * r.Layout.Container.width/<span class="hljs-number">100</span>) + <span class="hljs-string">'px'</span>,
			<span class="hljs-string">'margin-right'</span>: <span class="hljs-built_in">Math</span>.floor(r.preferences.margin.value[<span class="hljs-number">1</span>] * r.Layout.Container.width/<span class="hljs-number">100</span>) + <span class="hljs-string">'px'</span>,
			<span class="hljs-string">'height'</span>: <span class="hljs-built_in">Math</span>.floor(r.preferences.margin.value[<span class="hljs-number">0</span>] * r.Layout.Container.height/<span class="hljs-number">100</span>) + <span class="hljs-string">'px'</span>,
			<span class="hljs-string">'line-height'</span>: <span class="hljs-built_in">Math</span>.floor(r.preferences.margin.value[<span class="hljs-number">0</span>] * r.Layout.Container.height/<span class="hljs-number">100</span>) + <span class="hljs-string">'px'</span>
		});

		r.$footer.css({
			width: r.Layout.Reader.width + <span class="hljs-string">'px'</span>,
			<span class="hljs-string">'margin-left'</span>: <span class="hljs-built_in">Math</span>.floor(r.preferences.margin.value[<span class="hljs-number">3</span>] * r.Layout.Container.width/<span class="hljs-number">100</span>) + <span class="hljs-string">'px'</span>,
			<span class="hljs-string">'margin-right'</span>: <span class="hljs-built_in">Math</span>.floor(r.preferences.margin.value[<span class="hljs-number">1</span>] * r.Layout.Container.width/<span class="hljs-number">100</span>) + <span class="hljs-string">'px'</span>,
			<span class="hljs-string">'height'</span>: <span class="hljs-built_in">Math</span>.floor(r.preferences.margin.value[<span class="hljs-number">2</span>] * r.Layout.Container.height/<span class="hljs-number">100</span>) + <span class="hljs-string">'px'</span>,
			<span class="hljs-string">'line-height'</span>: <span class="hljs-built_in">Math</span>.floor(r.preferences.margin.value[<span class="hljs-number">2</span>] * r.Layout.Container.height/<span class="hljs-number">100</span>) + <span class="hljs-string">'px'</span>
		});

		_resizeImages();</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Update navigation variables</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		r.refreshLayout();
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Modifies some parameter related to the dimensions of the images and svg elements.
TODO Resize images based on column width, not just reader width</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> _resizeImages = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Get SVG elements</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		$(<span class="hljs-string">'svg'</span>, r.$reader).each(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(index,node)</span>{</span></pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Calculate 95% of the width and height of the container.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">var</span> width = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-number">0.95</span> * (r.Layout.Reader.width / r.Layout.Reader.columns - r.Layout.Reader.padding / <span class="hljs-number">2</span>));
			<span class="hljs-keyword">var</span> height = <span class="hljs-built_in">Math</span>.floor(<span class="hljs-number">0.95</span> * r.Layout.Reader.height);</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Modify SVG params when the dimensions are higher than the view space or they are set in % as this unit is not working in IE.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> ((node.getAttribute(<span class="hljs-string">'width'</span>) &amp;&amp; (node.getAttribute(<span class="hljs-string">'width'</span>) &gt; r.Layout.Reader.width || node.getAttribute(<span class="hljs-string">'width'</span>).indexOf(<span class="hljs-string">'%'</span>) !== -<span class="hljs-number">1</span>)) || !node.getAttribute(<span class="hljs-string">'width'</span>)) {
				node.setAttribute(<span class="hljs-string">'width'</span>, width);
			}
			<span class="hljs-keyword">if</span> ((node.getAttribute(<span class="hljs-string">'height'</span>) &amp;&amp; (node.getAttribute(<span class="hljs-string">'height'</span>) &gt; r.Layout.Reader.height || node.getAttribute(<span class="hljs-string">'height'</span>).indexOf(<span class="hljs-string">'%'</span>) !== -<span class="hljs-number">1</span>)) || !node.getAttribute(<span class="hljs-string">'height'</span>)) {
				node.setAttribute(<span class="hljs-string">'height'</span>, height);
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Modify the viewBox attribute if their dimensions are higher than the container.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			node.viewBox.baseVal.width = (node.viewBox.baseVal.width &gt; r.Layout.Reader.width) ? width : node.viewBox.baseVal.width;
			node.viewBox.baseVal.height = (node.viewBox.baseVal.height &gt; r.Layout.Reader.height) ? height : node.viewBox.baseVal.height;
			node.setAttribute(<span class="hljs-string">'transform'</span>, <span class="hljs-string">'scale(1)'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Modify children elements (images, rectangles, circles..) dimensions if they are higher than the container.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			$(<span class="hljs-keyword">this</span>).children().map(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
				<span class="hljs-keyword">if</span> ($(<span class="hljs-keyword">this</span>).attr(<span class="hljs-string">'width'</span>) &gt; r.Layout.Reader.width) {
					$(<span class="hljs-keyword">this</span>).attr(<span class="hljs-string">'width'</span>, width);
				}
				<span class="hljs-keyword">if</span> ($(<span class="hljs-keyword">this</span>).attr(<span class="hljs-string">'height'</span>) &gt; r.Layout.Reader.height) {
					$(<span class="hljs-keyword">this</span>).attr(<span class="hljs-string">'height'</span>, height);
				}
			});
			<span class="hljs-keyword">if</span> ($(<span class="hljs-keyword">this</span>).find(<span class="hljs-string">'path'</span>)) {</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Fix path elements dimensions.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">var</span> pathMaxWidth = <span class="hljs-number">0</span>;
				<span class="hljs-keyword">var</span> pathMaxHeight = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Take the highest width and height.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				$(<span class="hljs-keyword">this</span>).find(<span class="hljs-string">'path'</span>).each(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
					<span class="hljs-keyword">var</span> pathWidth = $(<span class="hljs-keyword">this</span>)[<span class="hljs-number">0</span>].getBoundingClientRect().width;
					<span class="hljs-keyword">var</span> pathHeight = $(<span class="hljs-keyword">this</span>)[<span class="hljs-number">0</span>].getBoundingClientRect().height;
					pathMaxWidth = (pathWidth &gt; pathMaxWidth) ? pathWidth : pathMaxWidth;
					pathMaxHeight = (pathHeight &gt; pathMaxHeight) ? pathHeight : pathMaxHeight;
				});
				<span class="hljs-keyword">if</span> (pathMaxWidth &gt; width || pathMaxHeight &gt; height) {</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Scale the elements to the correct proportion.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">var</span> scale = <span class="hljs-built_in">Math</span>.min(<span class="hljs-built_in">Math</span>.floor((width/pathMaxWidth)*<span class="hljs-number">10</span>)/<span class="hljs-number">10</span>,<span class="hljs-built_in">Math</span>.floor((height/pathMaxHeight)*<span class="hljs-number">10</span>)/<span class="hljs-number">10</span>);
					$(<span class="hljs-keyword">this</span>).find(<span class="hljs-string">'path'</span>).each(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>
						$(<span class="hljs-keyword">this</span>)[<span class="hljs-number">0</span>].setAttribute(<span class="hljs-string">'transform'</span>, <span class="hljs-string">'scale('</span> + scale + <span class="hljs-string">')'</span>);
					});
				}
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Remove SVG empty elements in some Webkit browsers is showing the content outside the SVG (Chrome).</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> ($(<span class="hljs-keyword">this</span>).children().length === <span class="hljs-number">0</span>) {
				$(<span class="hljs-keyword">this</span>).remove();
			}
		});
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Load the JSON file with all the information related to this book</p>
<ul>
<li><code>resource</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> loadInfo = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> {</span>
		<span class="hljs-keyword">var</span> defer = $.Deferred();
		loadFile(r.INF, <span class="hljs-string">'json'</span>).then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bookInfoLoaded</span><span class="hljs-params">(data)</span>{</span>
			r.SPINE = data.spine;
			r.TOC = data.toc;
			r.sample = data.sample;
			r.bookTitle = data.title;</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Check for startCFI, save it if and only if initCFI is null</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			_initCFI = data.startCfi &amp;&amp; !_initCFI ? data.startCfi : _initCFI;</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>If the OPF is in a folder…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (data.opfPath.indexOf(<span class="hljs-string">'/'</span>) !== -<span class="hljs-number">1</span>) {
				<span class="hljs-keyword">var</span> pathComponents = data.opfPath.split(<span class="hljs-string">'/'</span>);
				r.CONTENT_PATH_PREFIX = <span class="hljs-string">''</span>;
				<span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; (pathComponents.length-<span class="hljs-number">1</span>); i++){
					<span class="hljs-keyword">if</span> (i !== <span class="hljs-number">0</span>) {
						r.CONTENT_PATH_PREFIX += <span class="hljs-string">'/'</span>;
					}
					r.CONTENT_PATH_PREFIX  += pathComponents[i];
				}
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>If the PATH is empty set its value with the path of the first element in the spine.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (r.CONTENT_PATH_PREFIX === <span class="hljs-string">''</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Check the path has more then one component.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (r.SPINE[<span class="hljs-number">0</span>].href.indexOf(<span class="hljs-string">'/'</span>) !== -<span class="hljs-number">1</span>) {
					r.CONTENT_PATH_PREFIX = r.SPINE[<span class="hljs-number">0</span>].href.split(<span class="hljs-string">'/'</span>)[<span class="hljs-number">0</span>];
				}
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Set OPF</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			r.OPF = data.opfPath;
			<span class="hljs-keyword">if</span> (r.OPF !== <span class="hljs-string">''</span>) {
				loadFile(r.OPF).then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">opfFileLoaded</span><span class="hljs-params">(opf)</span>{</span>
					r.opf = opf;

					<span class="hljs-keyword">var</span> promise; <span class="hljs-comment">// promise object to return</span>
					<span class="hljs-keyword">if</span>(_initCFI === <span class="hljs-literal">null</span>){</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>if initURL is null, load the first chapter, otherwise load the specified chapter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						promise = !!_initURL ? r.Navigation.loadChapter(_initURL) : r.loadChapter(<span class="hljs-number">0</span>);
					} <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>load the chapter specified by the CFI, otherwise load chapter 0</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>						<span class="hljs-keyword">var</span> chapter = r.CFI.getChapterFromCFI(_initCFI);
						promise = r.loadChapter(chapter !== -<span class="hljs-number">1</span> ? chapter : <span class="hljs-number">0</span>);
					}
					promise.then(r.Navigation.update).then(defer.resolve, defer.reject);
				}, defer.reject);
			}
			r.Navigation.setNumberOfChapters(data.spine.length); <span class="hljs-comment">// Set number of chapters</span>
		}, defer.reject);</pre></div></div>
            
        </li>
        
        
        <li id="section-66">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-66">&#182;</a>
              </div>
              <p>notify client that info promise has been processed</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		defer.notify();
		<span class="hljs-keyword">return</span> defer.promise();
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-67">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-67">&#182;</a>
              </div>
              <p>Get a file from the server and display its content</p>
<ul>
<li><code>resource</code></li>
<li><code>callback</code></li>
</ul>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> loadFile = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(resource, type)</span> {</span>
		<span class="hljs-keyword">var</span> defer = $.Deferred();
		$.ajax({
			url: r.DOCROOT+<span class="hljs-string">'/'</span>+resource,
			dataType: (type) ? type : <span class="hljs-string">'text'</span>
		}).then(defer.resolve, <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(err)</span>{</span>
				defer.reject($.extend({}, r.Event.ERR_MISSING_FILE, {details: err}));
			});
		<span class="hljs-keyword">return</span> defer.promise();
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-68">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-68">&#182;</a>
              </div>
              <p>Load a chapter and go to the page pointed by the anchor value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	r.loadAnchor = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(c,a)</span>{</span>
		<span class="hljs-keyword">return</span> r.loadChapter(c).then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onLoadAnchorSuccess</span><span class="hljs-params">()</span>{</span>
			<span class="hljs-keyword">if</span> (a) {
				<span class="hljs-keyword">var</span> p = r.moveToAnchor(a);
				r.Navigation.loadPage(p);
				r.Navigation.update();
			} <span class="hljs-keyword">else</span> {
				r.Navigation.loadPage(<span class="hljs-number">0</span>);
				r.Navigation.update();
			}
		});
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-69">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-69">&#182;</a>
              </div>
              <p>Load a chapter with the index from the spine of this chapter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	r.loadChapter = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(chapterNumber)</span> {</span>
		<span class="hljs-keyword">var</span> defer = $.Deferred();

		r.CFI.setUp(chapterNumber);
		r.Navigation.setChapter(chapterNumber);
		r.$reader.css(<span class="hljs-string">'opacity'</span>, <span class="hljs-number">0</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-70">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-70">&#182;</a>
              </div>
              <p>success handler for load chapter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> loadChapterSuccess = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(data)</span>{</span>
			displayContent({content: data}).then(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span>{</span>

				r.Navigation.setNumberOfPages();
				r.$reader.css(<span class="hljs-string">'opacity'</span>, <span class="hljs-number">1</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-71">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-71">&#182;</a>
              </div>
              <p>Go to init cfi, if it was set.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span>(_initCFI){
					r.CFI.goToCFI(_initCFI);
					_initCFI = <span class="hljs-literal">null</span>;
				}

				defer.resolve();
			}, defer.reject); <span class="hljs-comment">// Execute the callback inside displayContent when its timer interval finish</span>
		};</pre></div></div>
            
        </li>
        
        
        <li id="section-72">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-72">&#182;</a>
              </div>
              <p>Check if the PATH is in the href value from the spine…</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> ((r.SPINE[chapterNumber].href.indexOf(r.CONTENT_PATH_PREFIX) !== -<span class="hljs-number">1</span>)) {
			loadFile(r.SPINE[chapterNumber].href).then(loadChapterSuccess, defer.reject);
		} <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-73">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-73">&#182;</a>
              </div>
              <p>If it is not, add it and load the chapter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			loadFile(r.CONTENT_PATH_PREFIX+<span class="hljs-string">'/'</span>+r.SPINE[chapterNumber].href).then(loadChapterSuccess, defer.reject);
		}

		<span class="hljs-keyword">return</span> defer.promise();
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-74">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-74">&#182;</a>
              </div>
              <p>Check if the browser supports css-columns.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-keyword">var</span> areColumnsSupported = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
		<span class="hljs-keyword">var</span> elemStyle = document.createElement(<span class="hljs-string">'ch'</span>).style,
			domPrefixes = <span class="hljs-string">'Webkit Moz O ms Khtml'</span>.split(<span class="hljs-string">' '</span>),
			prop = <span class="hljs-string">'columnCount'</span>,
			uc_prop = prop.charAt(<span class="hljs-number">0</span>).toUpperCase() + prop.substr(<span class="hljs-number">1</span>),
			props   = (prop + <span class="hljs-string">' '</span> + domPrefixes.join(uc_prop + <span class="hljs-string">' '</span>) + uc_prop).split(<span class="hljs-string">' '</span>);

		<span class="hljs-keyword">for</span> ( <span class="hljs-keyword">var</span> i <span class="hljs-keyword">in</span> props ) {
			<span class="hljs-keyword">if</span> ( elemStyle[ props[i] ] !== <span class="hljs-literal">undefined</span> ) {
				<span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
			}
		}
		<span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
	};

	<span class="hljs-keyword">return</span> r;

}(Reader || {}));</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
