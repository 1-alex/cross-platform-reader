<!DOCTYPE html>

<html>
<head>
  <title>book.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page">
            
              
              <a class="source" href="book.html">
                book.js
              </a>
            
              
              <a class="source" href="bookdata.html">
                bookdata.js
              </a>
            
              
              <a class="source" href="cfi.html">
                cfi.js
              </a>
            
              
              <a class="source" href="config.html">
                config.js
              </a>
            
              
              <a class="source" href="display.html">
                display.js
              </a>
            
              
              <a class="source" href="epub.html">
                epub.js
              </a>
            
              
              <a class="source" href="events.html">
                events.js
              </a>
            
              
              <a class="source" href="filters.html">
                filters.js
              </a>
            
              
              <a class="source" href="formatting.html">
                formatting.js
              </a>
            
              
              <a class="source" href="layout.html">
                layout.js
              </a>
            
              
              <a class="source" href="navigation.html">
                navigation.js
              </a>
            
              
              <a class="source" href="parse.html">
                parse.js
              </a>
            
              
              <a class="source" href="styles.html">
                styles.js
              </a>
            
              
              <a class="source" href="touch.html">
                touch.js
              </a>
            
              
              <a class="source" href="wrapper.html">
                wrapper.js
              </a>
            
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>book.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-pi">'use strict'</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>Sub module for managing a book’s meta-information (url, title, spine, isbn)</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-keyword">var</span> Reader = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(r)</span> </span>{

	<span class="hljs-keyword">var</span> defaultData = {</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>This version number identifies the data format:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		version: <span class="hljs-string">'2.0.0'</span>,
		spine: [],
		toc: [],
		title: <span class="hljs-string">''</span>,
		author: <span class="hljs-string">''</span>,
		opfPath: <span class="hljs-string">''</span>,
		contentPathPrefix: <span class="hljs-string">''</span>,
		opfDoc: <span class="hljs-literal">null</span>,
		totalWordCount: <span class="hljs-number">0</span>,
		totalImageCount: <span class="hljs-number">0</span>,
		sample: <span class="hljs-literal">false</span>
	};

	<span class="hljs-keyword">var</span> filesCache = {};</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Retrieves the spine data from the OPF document:
<a href="http://www.idpf.org/epub/20/spec/OPF_2.0.1_draft.htm#Section2.4">http://www.idpf.org/epub/20/spec/OPF_2.0.1_draft.htm#Section2.4</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getSpineFromOPF</span><span class="hljs-params">(opfDoc, pathPrefix)</span> </span>{
		<span class="hljs-keyword">return</span> $.map($(opfDoc.querySelector(<span class="hljs-string">'spine'</span>)).children(), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(itemref)</span> </span>{
			<span class="hljs-keyword">var</span> id = itemref.getAttribute(<span class="hljs-string">'idref'</span>),
					item = opfDoc.getElementById(id);
			<span class="hljs-keyword">return</span> {
				itemId: id,
				href: pathPrefix + item.getAttribute(<span class="hljs-string">'href'</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>The default is “yes”, so unlike it’s “no”, the spine item is linear:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				linear: itemref.getAttribute(<span class="hljs-string">'linear'</span>) === <span class="hljs-string">'no'</span> ? <span class="hljs-literal">false</span> : <span class="hljs-literal">true</span>,
				mediaType: item.getAttribute(<span class="hljs-string">'media-type'</span>)
			};
		});
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Retrieves the TOC from a given navMap entry point (recursive function):</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTOCFromNavMap</span><span class="hljs-params">(navMap, pathPrefix)</span> </span>{
		<span class="hljs-keyword">return</span> $.map($(navMap).children(<span class="hljs-string">'navPoint'</span>), <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(navPoint)</span> </span>{
			<span class="hljs-keyword">var</span> $navPoint = $(navPoint),
				data = {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>active: true, // false if HTML file is not available, e.g. in samples</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					href: pathPrefix + $navPoint.children(<span class="hljs-string">'content'</span>).attr(<span class="hljs-string">'src'</span>),
					label: $navPoint.children(<span class="hljs-string">'navLabel'</span>).children(<span class="hljs-string">'text'</span>).text()
				},
				children = getTOCFromNavMap(navPoint, pathPrefix);
			<span class="hljs-keyword">if</span> (children.length) {
				data.children = children;
			}
			<span class="hljs-keyword">return</span> data;
		});
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Retrieves the TOC from a given collection of list items (recursive function):</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTOCFromNavList</span><span class="hljs-params">(navList, pathPrefix)</span> </span>{
		<span class="hljs-keyword">return</span> $.map(navList, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(listItem)</span> </span>{
			<span class="hljs-keyword">var</span> $listItem = $(listItem),
				data = {</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>active: true, // false if HTML file is not available, e.g. in samples</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					href: pathPrefix + $listItem.children(<span class="hljs-string">'a'</span>).attr(<span class="hljs-string">'href'</span>),
					label: $listItem.children(<span class="hljs-string">'a,span'</span>).text()
				},
				children = getTOCFromNavList($listItem.children(<span class="hljs-string">'ol'</span>).children(<span class="hljs-string">'li'</span>), pathPrefix);
			<span class="hljs-keyword">if</span> (children.length) {
				data.children = children;
			}
			<span class="hljs-keyword">return</span> data;
		});
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Get a file from the server:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadFile</span><span class="hljs-params">(resource, type)</span> </span>{
		<span class="hljs-keyword">var</span> promise = filesCache[resource],
				defer;
		<span class="hljs-keyword">if</span> (promise !== <span class="hljs-literal">undefined</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>Delete entries from the files cache as soon as they have been used.
This prevents storing too much data in memory:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">delete</span> filesCache[resource];
			<span class="hljs-keyword">return</span> promise;
		}
		defer = $.Deferred();
		$.ajax({
			url: r.DOCROOT + <span class="hljs-string">'/'</span> + resource,
			dataType: type ? type : <span class="hljs-string">'text'</span>
		}).then(defer.resolve, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> </span>{
			defer.reject($.extend({}, r.Event.ERR_MISSING_FILE, {details: err.responseText}));
		});
		<span class="hljs-keyword">return</span> defer.promise();
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Load a file and store the promise in an in-memory store:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">preloadFile</span><span class="hljs-params">(resource, type)</span> </span>{
		<span class="hljs-keyword">var</span> promise = loadFile(resource, type);
		filesCache[resource] = promise;
		<span class="hljs-keyword">return</span> promise;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Retrieve the opfPath from the root file:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadOpfPath</span><span class="hljs-params">(data)</span> </span>{
		<span class="hljs-keyword">return</span> loadFile(r.ROOTFILE_INFO_PATH, <span class="hljs-string">'xml'</span>).then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">rootFileLoaded</span><span class="hljs-params">(rootDoc)</span> </span>{
			data.opfPath = rootDoc.querySelector(<span class="hljs-string">'rootfile'</span>).getAttribute(<span class="hljs-string">'full-path'</span>);
			<span class="hljs-keyword">return</span> data;
		});
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Returns a document for a valid XML string:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseXML</span><span class="hljs-params">(content)</span> </span>{
		<span class="hljs-keyword">return</span> (<span class="hljs-keyword">new</span> DOMParser()).parseFromString(content, <span class="hljs-string">'text/xml'</span>);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>Load opfFile and store opfDoc and contentPathPrefix in the given data object:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadOpfData</span><span class="hljs-params">(data)</span> </span>{
		<span class="hljs-keyword">if</span> (data.opfPath) {
			<span class="hljs-keyword">var</span> pathPrefix = data.opfPath.split(<span class="hljs-string">'/'</span>).slice(<span class="hljs-number">0</span>, -<span class="hljs-number">1</span>).join(<span class="hljs-string">'/'</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Add a trailing slash if we have a path prefix:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			data.contentPathPrefix = pathPrefix &amp;&amp; pathPrefix + <span class="hljs-string">'/'</span>;
		}
		<span class="hljs-keyword">if</span> (data.opf) {</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>OPF data is provided via XML string</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			data.opfDoc = parseXML(data.opf);
			<span class="hljs-keyword">return</span> $.Deferred().resolve(data).promise();
		}
		<span class="hljs-keyword">return</span> loadFile(data.opfPath).then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">opfFileLoaded</span><span class="hljs-params">(content)</span> </span>{
			data.opf = content;
			data.opfDoc = parseXML(content);
			<span class="hljs-keyword">return</span> data;
		});
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Function to load the TOC data from the EPUB2 NCX file or the EPUB3 navigation document:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadTOCData</span><span class="hljs-params">(data)</span> </span>{
		<span class="hljs-keyword">var</span> opfDoc = data.opfDoc,
				navItem = opfDoc.querySelector(<span class="hljs-string">'manifest'</span>).querySelector(<span class="hljs-string">'item[properties="nav"]'</span>),
				navHref = navItem &amp;&amp; navItem.getAttribute(<span class="hljs-string">'href'</span>),</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>EPUB v2 requirements state:</p>
<blockquote>
<p>The item that describes the NCX must be referenced by the spine toc attribute.
<a href="http://www.idpf.org/epub/20/spec/OPF_2.0.1_draft.htm#Section2.4.1.2">http://www.idpf.org/epub/20/spec/OPF_2.0.1_draft.htm#Section2.4.1.2</a>
However, some books might not honor that requirement, so we fall back to the ID “ncx” as a default:</p>
</blockquote>

            </div>
            
            <div class="content"><div class='highlight'><pre>				ncxId = !navHref &amp;&amp; (opfDoc.querySelector(<span class="hljs-string">'spine'</span>).getAttribute(<span class="hljs-string">'toc'</span>) || <span class="hljs-string">'ncx'</span>),
				ncxHref = ncxId &amp;&amp; opfDoc.getElementById(ncxId).getAttribute(<span class="hljs-string">'href'</span>);
		<span class="hljs-keyword">if</span> (navHref) {</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>EPUB v3 navigation document:
<a href="http://www.idpf.org/epub/30/spec/epub30-contentdocs.html#sec-xhtml-nav">http://www.idpf.org/epub/30/spec/epub30-contentdocs.html#sec-xhtml-nav</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">return</span> loadFile(data.contentPathPrefix + navHref).then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">navDocLoaded</span><span class="hljs-params">(navDoc)</span> </span>{
				<span class="hljs-keyword">var</span> navList = $(navDoc).filter(<span class="hljs-string">'nav[epub\\:type="toc"]'</span>).children(<span class="hljs-string">'ol'</span>).children(<span class="hljs-string">'li'</span>);
				data.toc = getTOCFromNavList(navList, data.contentPathPrefix);
				<span class="hljs-keyword">return</span> data;
			});
		}</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>EPUB2 NCX file:
<a href="http://www.idpf.org/epub/20/spec/OPF_2.0.1_draft.htm#Section2.4.1">http://www.idpf.org/epub/20/spec/OPF_2.0.1_draft.htm#Section2.4.1</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">return</span> loadFile(data.contentPathPrefix + ncxHref, <span class="hljs-string">'xml'</span>).then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ncxFileLoaded</span><span class="hljs-params">(ncxDoc)</span> </span>{
			data.toc = getTOCFromNavMap(ncxDoc.querySelector(<span class="hljs-string">'navMap'</span>), data.contentPathPrefix);
			<span class="hljs-keyword">return</span> data;
		});
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Load book meta data if book-info.json is not available:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadBookMetaData</span><span class="hljs-params">(args)</span> </span>{
		<span class="hljs-keyword">return</span> loadOpfPath({})
			.then(loadOpfData)
			.then(loadTOCData)
			.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Retrieve meta data from OPF document:
<a href="http://www.idpf.org/epub/20/spec/OPF_2.0.1_draft.htm#Section2.2">http://www.idpf.org/epub/20/spec/OPF_2.0.1_draft.htm#Section2.2</a></p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">var</span> opfDoc = data.opfDoc,
						metadata = opfDoc.querySelector(<span class="hljs-string">'metadata'</span>),
						titleElement = metadata.querySelector(<span class="hljs-string">'title'</span>),
						authorElement = metadata.querySelector(<span class="hljs-string">'creator'</span>);
				<span class="hljs-keyword">return</span> $.extend(data, {
					title: titleElement &amp;&amp; titleElement.textContent,
					author: authorElement &amp;&amp; authorElement.textContent,
					spine: getSpineFromOPF(opfDoc, data.contentPathPrefix)
				}, args);
			});
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-24">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-24">&#182;</a>
              </div>
              <p>Load book meta data from book-info.json:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadBookInfo</span><span class="hljs-params">(args)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-25">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-25">&#182;</a>
              </div>
              <p>Check if the book info is available (explicit type check as the property might be undefined):</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (args.hasBookInfo === <span class="hljs-literal">false</span>) {
			<span class="hljs-keyword">return</span> $.Deferred().reject().promise();
		}
		<span class="hljs-keyword">return</span> loadFile(r.BOOK_INFO_PATH, <span class="hljs-string">'json'</span>)
			.then(loadOpfData)
			.then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{
				<span class="hljs-keyword">return</span> $.extend(data, args);
			});
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-26">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-26">&#182;</a>
              </div>
              <p>Count the number of words in the given HTML string:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">countWords</span><span class="hljs-params">(str)</span> </span>{
		str = str</pre></div></div>
            
        </li>
        
        
        <li id="section-27">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-27">&#182;</a>
              </div>
              <p>Replace the title element, as we don’t count its contents:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			.replace(<span class="hljs-regexp">/&lt;title&gt;[^&lt;]+&lt;\/title&gt;/i</span>, <span class="hljs-string">''</span>)</pre></div></div>
            
        </li>
        
        
        <li id="section-28">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-28">&#182;</a>
              </div>
              <p>Replace all HTML elements with single spaces:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			.replace(<span class="hljs-regexp">/(&lt;[^&gt;]+&gt;)/gi</span>, <span class="hljs-string">' '</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-29">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-29">&#182;</a>
              </div>
              <p>Convert all HTML entities to their textual representation,
so that whitespace entities are not counted as text:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		str = $(<span class="hljs-string">'&lt;p&gt;'</span>).html(str).text();</pre></div></div>
            
        </li>
        
        
        <li id="section-30">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-30">&#182;</a>
              </div>
              <p>Calculate the word matches:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">var</span> match = str.match(<span class="hljs-regexp">/\s+\S+/g</span>);
		<span class="hljs-keyword">return</span> match ? match.length : <span class="hljs-number">0</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-31">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-31">&#182;</a>
              </div>
              <p>Count the number of images (and SVG elements) in the given HTML string:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">countImages</span><span class="hljs-params">(str)</span> </span>{
		<span class="hljs-keyword">var</span> result = str.match(<span class="hljs-regexp">/(&lt;img)|(&lt;svg)/gi</span>);
		<span class="hljs-keyword">return</span> result ? result.length : <span class="hljs-number">0</span>;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-32">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-32">&#182;</a>
              </div>
              <p>Strip any HTML comments from the given HTML string:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">stripHTMLComments</span><span class="hljs-params">(str)</span> </span>{
		<span class="hljs-keyword">return</span> str.replace(<span class="hljs-regexp">/&lt;!--.*?--&gt;/g</span>, <span class="hljs-string">''</span>);
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-33">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-33">&#182;</a>
              </div>
              <p>Function to handle a given number of parallel requests:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parallelRequestsHandler</span><span class="hljs-params">(list, request)</span> </span>{
		<span class="hljs-keyword">var</span> defer = $.Deferred(),
				count = list.length,
				index = <span class="hljs-number">0</span>,
				maxRequests = r.preferences.maxParallelRequests.value,
				pendingRequests = <span class="hljs-number">0</span>,
				handleResponse = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
					pendingRequests--;
					initRequests();
				},
				sendRequests = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
					<span class="hljs-keyword">while</span> (index &lt; count &amp;&amp; pendingRequests &lt; maxRequests) {
						pendingRequests++;
						request(list[index++]).always(handleResponse);
					}
				},
				initRequests = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
					<span class="hljs-keyword">if</span> (index === count) {
						<span class="hljs-keyword">if</span> (!pendingRequests) {
							defer.resolve(list);
						}
					} <span class="hljs-keyword">else</span> {
						sendRequests();
					}
				};
		initRequests();
		<span class="hljs-keyword">return</span> defer.promise();
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-34">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-34">&#182;</a>
              </div>
              <p>Function to parse a chapter in the spine to calculate word- and image- count:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseChapter</span><span class="hljs-params">(spineItem)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-35">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-35">&#182;</a>
              </div>
              <p>Check if the spine item is available (explicit type check as the active property might be undefined):</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		<span class="hljs-keyword">if</span> (spineItem.active === <span class="hljs-literal">false</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-36">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-36">&#182;</a>
              </div>
              <p>Given file is not available in the EPUB</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">return</span> $.Deferred().reject().promise();
		}
		<span class="hljs-keyword">return</span> loadFile(spineItem.href)
			.done(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(result)</span> </span>{
				result = stripHTMLComments(result);
				spineItem.imageCount = countImages(result);
				<span class="hljs-keyword">if</span> (spineItem.wordCount === <span class="hljs-literal">undefined</span>) {
					spineItem.wordCount = countWords(result);
				}
				spineItem.active = <span class="hljs-literal">true</span>;
			})
			.fail(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-37">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-37">&#182;</a>
              </div>
              <p>Given file is not available in the EPUB:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				spineItem.active = <span class="hljs-literal">false</span>;
			});
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-38">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-38">&#182;</a>
              </div>
              <p>Function to parse each chapter in the spine to calculate word- and image- count:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseChapters</span><span class="hljs-params">(data)</span> </span>{
		<span class="hljs-keyword">return</span> parallelRequestsHandler(data.spine, parseChapter).then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> data;
		});
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-39">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-39">&#182;</a>
              </div>
              <p>Wrapper function to load book meta data from book-info.json or EPUB meta files:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadBookData</span><span class="hljs-params">(args)</span> </span>{
		<span class="hljs-keyword">var</span> defer = $.Deferred();</pre></div></div>
            
        </li>
        
        
        <li id="section-40">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-40">&#182;</a>
              </div>
              <p>Notify the client that loading of the book meta data has been started:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		defer.notify({type: <span class="hljs-string">'meta.loading'</span>});
		<span class="hljs-keyword">if</span> (args.spine) {</pre></div></div>
            
        </li>
        
        
        <li id="section-41">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-41">&#182;</a>
              </div>
              <p>Book data is provided via arguments, so we only load the opfData:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			loadOpfData($.extend({}, args))
				.then(defer.resolve, defer.reject);
			<span class="hljs-keyword">return</span> defer.promise();
		} <span class="hljs-keyword">else</span> {</pre></div></div>
            
        </li>
        
        
        <li id="section-42">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-42">&#182;</a>
              </div>
              <p>Try loading book-info.json:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			loadBookInfo(args).then(
				defer.resolve,
				<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
					args.hasBookInfo = <span class="hljs-literal">false</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-43">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-43">&#182;</a>
              </div>
              <p>book-info.json not available, load meta data manually:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					loadBookMetaData(args)
						.then(defer.resolve, defer.reject);
				}
			);</pre></div></div>
            
        </li>
        
        
        <li id="section-44">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-44">&#182;</a>
              </div>
              <p>Book data is not provided via arguments</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">return</span> defer.promise().then(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> </span>{</pre></div></div>
            
        </li>
        
        
        <li id="section-45">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-45">&#182;</a>
              </div>
              <p>loadProgressData === 1 -&gt; load progress data on Book load</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (r.preferences.loadProgressData.value === <span class="hljs-number">1</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-46">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-46">&#182;</a>
              </div>
              <p>Parse the chapters for the word/image count:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>					<span class="hljs-keyword">return</span> parseChapters(data);
				}
				<span class="hljs-keyword">return</span> data;
			});
		}
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-47">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-47">&#182;</a>
              </div>
              <p>Function to count the total word- and image- count for the given book data:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">calculateTotals</span><span class="hljs-params">(book)</span> </span>{
		<span class="hljs-keyword">var</span> spine = book.spine,
				wordCount = <span class="hljs-number">0</span>,
				imageCount = <span class="hljs-number">0</span>,
				i = <span class="hljs-number">0</span>,
				item;
		<span class="hljs-keyword">while</span> ((item = spine[i++])) {</pre></div></div>
            
        </li>
        
        
        <li id="section-48">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-48">&#182;</a>
              </div>
              <p>Check if the spine item is available (explicit type check as the active property might be undefined):</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (item.active !== <span class="hljs-literal">false</span>) {
				wordCount += item.wordCount;
				imageCount += item.imageCount;
			}
		}
		book.totalWordCount = wordCount;
		book.totalImageCount = imageCount;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-49">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-49">&#182;</a>
              </div>
              <p>Function to retrieve the associated TOC item for a given href and optional currentPage.
The search starts from the given TOC item to simplify recursion:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseTOCItem</span><span class="hljs-params">(item, href, currentPage)</span> </span>{
		<span class="hljs-keyword">var</span> children = item.children,
			result,
			i,
			childItem,
			anchorId,
			anchorPage;
		<span class="hljs-keyword">if</span> (item.href &amp;&amp; item.href.indexOf(href) === <span class="hljs-number">0</span>) {
			<span class="hljs-keyword">if</span> (!currentPage) {
				<span class="hljs-keyword">return</span> item;
			}
			result = item;
		}
		<span class="hljs-keyword">if</span> (children) {
			<span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>; i &lt; children.length; i++) {
				childItem = parseTOCItem(children[i], href, currentPage);
				<span class="hljs-keyword">if</span> (childItem) {
					<span class="hljs-keyword">if</span> (result) {
						anchorId = childItem.href.split(<span class="hljs-string">'#'</span>)[<span class="hljs-number">1</span>];
						<span class="hljs-keyword">if</span> (!anchorId) {
							<span class="hljs-keyword">continue</span>;
						}
						anchorPage = r.returnPageElement(<span class="hljs-string">'#'</span> + anchorId);
						<span class="hljs-keyword">if</span> (anchorPage === -<span class="hljs-number">1</span>) {
							<span class="hljs-keyword">continue</span>;
						}
						<span class="hljs-keyword">if</span> (anchorPage &gt; currentPage) {
							<span class="hljs-keyword">break</span>;
						}
					}
					result = childItem;
				}
			}
		}
		<span class="hljs-keyword">return</span> result;
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-50">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-50">&#182;</a>
              </div>
              <p>Adds labels from TOC and progress information to the spine:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addLabelAndProgressToSpine</span><span class="hljs-params">(book)</span> </span>{
		<span class="hljs-keyword">var</span> spine = book.spine,
				totalCount = book.getTotalWordCount(),
				currentCount = <span class="hljs-number">0</span>,
				i = <span class="hljs-number">0</span>,
				spineItem,
				tocItem;
		<span class="hljs-keyword">while</span> ((spineItem = spine[i++])) {
			<span class="hljs-keyword">if</span> (spineItem.label === <span class="hljs-literal">undefined</span>) {
				tocItem = book.getTOCItem(spineItem.href);
				<span class="hljs-keyword">if</span> (tocItem) {
					spineItem.label = tocItem.label;
				}
			}</pre></div></div>
            
        </li>
        
        
        <li id="section-51">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-51">&#182;</a>
              </div>
              <p>Check if the spine item is available (explicit type check as the active property might be undefined):</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>			<span class="hljs-keyword">if</span> (spineItem.active !== <span class="hljs-literal">false</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-52">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-52">&#182;</a>
              </div>
              <p>Add +1 to the current word count of the previous chapters
to identify the progress for the first word of the chapter:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				spineItem.progress = (currentCount + <span class="hljs-number">1</span>) / totalCount * <span class="hljs-number">100</span>;
				currentCount += book.getWordCount(spineItem);
			}
		}
	}</pre></div></div>
            
        </li>
        
        
        <li id="section-53">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-53">&#182;</a>
              </div>
              <p>Initialize the book with the given data:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">initializeBookData</span><span class="hljs-params">(data)</span> </span>{
		<span class="hljs-keyword">var</span> book = r.Book;
		$.extend(book, data);
		calculateTotals(book);
		addLabelAndProgressToSpine(book);
		r.Navigation.setNumberOfChapters(book.spine.length);
		<span class="hljs-keyword">return</span> book;
	}

	r.Book = {</pre></div></div>
            
        </li>
        
        
        <li id="section-54">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-54">&#182;</a>
              </div>
              <p>Method to load a file from the book resources:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		loadFile: loadFile,</pre></div></div>
            
        </li>
        
        
        <li id="section-55">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-55">&#182;</a>
              </div>
              <p>Method to preload a file for faster subsequent access:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		preloadFile: preloadFile,</pre></div></div>
            
        </li>
        
        
        <li id="section-56">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-56">&#182;</a>
              </div>
              <p>Load the book information.
Uses the given arguments and loads any missing data:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		load: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(args)</span> </span>{
			<span class="hljs-keyword">this</span>.reset();
			<span class="hljs-keyword">return</span> loadBookData(args || {}).then(initializeBookData);
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-57">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-57">&#182;</a>
              </div>
              <p>Load the spine progress data (word- and image count):</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		loadProgressData: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> parseChapters(<span class="hljs-keyword">this</span>).then(initializeBookData);
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-58">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-58">&#182;</a>
              </div>
              <p>Reset the module to default values:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		reset: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			$.extend(<span class="hljs-keyword">this</span>, defaultData);
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-59">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-59">&#182;</a>
              </div>
              <p>Retrieve the associated TOC item for a given href and optional currentPage:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		getTOCItem: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(href, currentPage)</span> </span>{
			<span class="hljs-keyword">return</span> parseTOCItem({children: <span class="hljs-keyword">this</span>.toc}, href, currentPage);
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-60">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-60">&#182;</a>
              </div>
              <p>Get the spine index for the given URL:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		getSpineIndex: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(url)</span> </span>{
			<span class="hljs-keyword">var</span> spine = <span class="hljs-keyword">this</span>.spine,
					i = <span class="hljs-number">0</span>,
					item;
			<span class="hljs-keyword">while</span> ((item = spine[i])) {</pre></div></div>
            
        </li>
        
        
        <li id="section-61">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-61">&#182;</a>
              </div>
              <p>Check if the spine item is available (explicit type check as the active property might be undefined):</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>				<span class="hljs-keyword">if</span> (item.active !== <span class="hljs-literal">false</span> &amp;&amp; item.href.indexOf(url.split(<span class="hljs-string">'#'</span>)[<span class="hljs-number">0</span>]) === <span class="hljs-number">0</span>) {
					<span class="hljs-keyword">return</span> i;
				}
				i++;
			}
			<span class="hljs-keyword">return</span> -<span class="hljs-number">1</span>;
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-62">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-62">&#182;</a>
              </div>
              <p>Retrieve the total word count of a book (takes image count into account):</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		getTotalWordCount: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.totalWordCount + (<span class="hljs-keyword">this</span>.totalImageCount || <span class="hljs-number">0</span>) * r.preferences.imageWordCount.value;
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-63">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-63">&#182;</a>
              </div>
              <p>Retrieve the word count of a chapter (takes image count into account):</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		getWordCount: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(spineItem)</span> </span>{
			<span class="hljs-keyword">return</span> spineItem.wordCount + (spineItem.imageCount || <span class="hljs-number">0</span>) * r.preferences.imageWordCount.value;
		},</pre></div></div>
            
        </li>
        
        
        <li id="section-64">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-64">&#182;</a>
              </div>
              <p>Export the book data that can be converted to JSON:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>		getData: <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> </span>{
			<span class="hljs-keyword">var</span> data = {},
					prop,
					value;
			<span class="hljs-keyword">for</span> (prop <span class="hljs-keyword">in</span> <span class="hljs-keyword">this</span>) {
				value = <span class="hljs-keyword">this</span>[prop];
				<span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.hasOwnProperty(prop) &amp;&amp; <span class="hljs-keyword">typeof</span> value !== <span class="hljs-string">'function'</span> &amp;&amp; !(value <span class="hljs-keyword">instanceof</span> Node)) {
					data[prop] = value;
				}
			}
			<span class="hljs-keyword">return</span> data;
		}
	};</pre></div></div>
            
        </li>
        
        
        <li id="section-65">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-65">&#182;</a>
              </div>
              <p>Initialize the Reader with default (empty) book data:</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	r.Book.reset();

	<span class="hljs-keyword">return</span> r;
}(Reader || {}));</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
